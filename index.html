<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>사업지구 공정률 대시보드</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Firebase (Compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <style>
    :root {
      --bg:#0b1020; --card:#111834; --muted:#8fa3c1; --text:#e8eefb; --brand:#5aa0ff; --accent:#46e0b7; --danger:#ef4444;
      --ring:#233053;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0a0f1e 0%,#0b1226 100%);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(10,15,30,.7);border-bottom:1px solid #1b2446}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .row{display:grid;gap:16px}
    .row.cols-2{grid-template-columns:repeat(2,1fr)}
    .card{background:linear-gradient(180deg,#0f1732 0%,#0e1530 100%);border:1px solid #1b2446;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .card h2{font-size:18px;margin:0 0 8px 0;color:#cfe0ff}
    .card .pad{padding:16px}
    .kpi{display:flex;align-items:baseline;gap:8px}
    .kpi .big{font-size:24px;font-weight:800}
    .kpi .sub{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:1px solid #2a3a70;background:#12204a;color:#eaf2ff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn:hover{background:#16265a}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .danger{background:#2b0e13;border-color:#4a0d17}
    .danger:hover{background:#3a131a}
    .accent{background:#0d2b24;border-color:#0a4034}
    .accent:hover{background:#123c32}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    thead th{font-size:12px;text-transform:uppercase;color:#a9b8d9;text-align:left;padding:0 8px}
    tbody td{background:linear-gradient(180deg,#0f1732 0%,#0e1530 100%);border:1px solid #1b2446;border-left:0;border-right:0;padding:12px 8px}
    tbody tr{border-radius:12px;overflow:hidden}
    tbody td:first-child{border-left:1px solid #1b2446;border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody td:last-child{border-right:1px solid #1b2446;border-top-right-radius:12px;border-bottom-right-radius:12px}

    input[type="number"], input[type="text"], textarea, select{
      width:100%;background:#0a1330;border:1px solid #1f2c57;color:#e8eefb;border-radius:10px;padding:8px;outline:none
    }
    input:focus, textarea:focus{box-shadow:0 0 0 3px var(--ring)}
    textarea{min-height:64px;resize:vertical}

    .delta{font-weight:700}
    .delta.changed{color:var(--danger)}
    .tag{display:inline-flex;align-items:center;gap:6px;border:1px solid #27407d;background:#0c1a3f;padding:6px 10px;border-radius:999px;font-size:12px;color:#cfe0ff}
    .footer{color:#91a1c4;font-size:12px;margin-top:8px}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .hidden{display:none}

    /* 새로운 대시보드 레이아웃 */
    .dash{display:grid;grid-template-columns:380px 1fr;gap:16px}
    @media (max-width: 980px){
      .dash{grid-template-columns:1fr}
    }
    .dash-left .kpi{margin-top:4px}
    .dash-right{display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:minmax(0,auto);gap:16px}
    .span-2{grid-column:1 / span 2}
  </style>
</head>
<body>
  <header>
    <div class="wrap flex" style="padding:12px 20px">
      <div class="flex" style="gap:10px">
        <span class="tag">사업지구 공정률 대시보드</span>
        <span class="muted">실시간 동기화 (Firebase)</span>
      </div>
      <div class="spacer"></div>
      <div class="flex">
        <span id="userInfo" class="muted">로그인 필요</span>
        <button id="btnSignIn" class="btn">Google 로그인</button>
        <button id="btnSignOut" class="btn hidden">로그아웃</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:16px">
    <!-- NEW DASHBOARD LAYOUT: 도넛 왼쪽, 오른쪽에 top/bottom/확인사항 (2줄 배치) -->
    <div class="dash">
      <!-- LEFT: Donut -->
      <div class="card dash-left"><div class="pad">
        <h2>전체 공정률</h2>
        <div class="kpi"><span id="kpiProgress" class="big">0%</span><span class="sub" id="kpiParcels">0 / 0 필지</span></div>
        <canvas id="overallDonut" style="margin-top:6px;height:120px"></canvas>
      </div></div>

      <!-- RIGHT: grid (row1: top/bottom, row2: 확인사항 span2) -->
      <div class="dash-right">
        <div class="card"><div class="pad">
          <h2>Top 3 사업지구</h2>
          <ol id="top3" class="muted" style="padding-left:18px;margin:0"></ol>
          <div class="footer">진행률(%) 기준</div>
        </div></div>
        <div class="card"><div class="pad">
          <h2>Bottom 3 사업지구</h2>
          <ol id="bottom3" class="muted" style="padding-left:18px;margin:0"></ol>
          <div class="footer">진행률(%) 기준</div>
        </div></div>
        <div class="card span-2"><div class="pad">
          <h2>확인사항</h2>
          <textarea id="checklist" placeholder="예: 자료 보완 대상 지구, 일정 리스크, 대민 안내 필요사항 등"></textarea>
          <div class="footer">※ 로그인 시 팀 전체와 실시간 공유됩니다.</div>
        </div></div>
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="card" style="margin-top:16px"><div class="pad">
      <h2>관리자 도구</h2>
      <div class="btn-row" style="margin-bottom:10px">
        <button id="btnNewWeek" class="btn">새 주 시작 (지난 주 값 자동 이월)</button>
        <button id="btnAddSample" class="btn accent">샘플 데이터 추가</button>
        <button id="btnExport" class="btn">CSV 내보내기</button>
      </div>
      <div class="row cols-2">
        <div>
          <h3 style="margin:0 0 8px 0;color:#cfe0ff;font-size:14px">사업지구 추가</h3>
          <div class="row cols-2">
            <input id="inName" type="text" placeholder="사업지구명" />
            <input id="inTeam" type="text" placeholder="담당팀" />
          </div>
          <div class="row cols-2" style="margin-top:8px">
            <input id="inTotal" type="number" placeholder="총 필지" />
            <input id="inCompleted" type="number" placeholder="완료(이번 주)" />
          </div>
          <div class="btn-row" style="margin-top:8px">
            <button id="btnAddProject" class="btn">추가</button>
          </div>
          <div class="footer">※ 로그인한 사용자만 수정/추가 가능. 지난 주 대비 변동 시 붉은 굵은 글씨로 Δ 표시.</div>
        </div>
        <div>
          <h3 style="margin:0 0 8px 0;color:#cfe0ff;font-size:14px">설명</h3>
          <ul class="muted" style="margin:0 0 6px 16px;padding:0">
            <li>도넛 차트: 전체 완료/잔여 필지 (차트 높이 절반 적용)</li>
            <li>Top/Bottom 3: 진행률 상/하위</li>
            <li>확인사항: 전사 공유 메모(실시간)</li>
          </ul>
        </div>
      </div>
    </div></div>

    <!-- TABLE -->
    <div class="card" style="margin-top:16px"><div class="pad">
      <h2>담당팀별 사업지구 현황</h2>
      <table>
        <thead>
          <tr>
            <th>담당팀</th>
            <th>사업지구</th>
            <th>총 필지</th>
            <th>완료 (이번 주)</th>
            <th>공정률 (%)</th>
            <th>Δ 주간 (pp)</th>
            <th>LX 인수인계</th>
            <th>소관청 피드백</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div></div>

  </main>

  <script>
  // =========================
  // 1) Firebase 설정 (아래를 본인 프로젝트 정보로 교체)
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyBDQSpN1_hV5cj9wDHqzxwIEfWHUsuMEu0",
    authDomain: "weekend-6d16d.firebaseapp.com",
    projectId: "weekend-6d16d",
    storageBucket: "weekend-6d16d.firebasestorage.app",
    messagingSenderId: "399772383646",
    appId: "1:399772383646:web:21208b83404479669c3e8f",
    measurementId: "G-35FK2FRMBZ"
};

  // 간단한 헬퍼: config가 채워졌는지 확인
  function looksUnconfigured(cfg){
    return Object.values(cfg).some(v => typeof v === 'string' && v.startsWith('YOUR_'));
  }

  let app, db, auth;
  let unsubscribeProjects = null;
  let donutChart = null;
  let currentUser = null;

  try {
    if(looksUnconfigured(firebaseConfig)){
      throw new Error('Firebase 설정이 필요합니다. index.html 상단의 firebaseConfig를 교체하세요.');
    }
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
  } catch(err){
    console.error(err);
    // Firebase 미설정 시 데모 모드 경고만 출력
    document.getElementById('userInfo').textContent = 'Firebase 미설정 (보기 전용)';
    document.getElementById('btnSignIn').disabled = true;
    document.getElementById('btnSignOut').disabled = true;
  }

  // =========================
  // 2) 로그인 / 권한
  // =========================
  const btnSignIn = document.getElementById('btnSignIn');
  const btnSignOut = document.getElementById('btnSignOut');
  const userInfo = document.getElementById('userInfo');

  if(auth){
    auth.onAuthStateChanged(user => {
      currentUser = user;
      if(user){
        userInfo.textContent = `${user.displayName || user.email} 님 로그인`;
        btnSignIn.classList.add('hidden');
        btnSignOut.classList.remove('hidden');
        setControlsEnabled(true);
      } else {
        userInfo.textContent = '로그인 필요';
        btnSignIn.classList.remove('hidden');
        btnSignOut.classList.add('hidden');
        setControlsEnabled(false);
      }
    });

    btnSignIn.addEventListener('click', async () => {
      try{
        await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
      }catch(e){ alert(e.message); }
    });
    btnSignOut.addEventListener('click', async () => {
      await auth.signOut();
    });
  }

  function setControlsEnabled(enabled){
    const adminBtns = [document.getElementById('btnNewWeek'), document.getElementById('btnAddProject'), document.getElementById('btnAddSample')];
    adminBtns.forEach(b => b && (b.disabled = !enabled));
    // 확인사항 편집 가능 여부
    document.getElementById('checklist').disabled = !enabled;
    renderProjects(latestProjects);
  }

  // =========================
  // 3) Firestore 데이터 구조
  //    컬렉션: projects (표/대시보드용)
  //    문서 필드 예시:
  //    { name, team, total, completed, completed_last_week, lxNotes, authorityFeedback, updatedAt }
  //    문서: settings/dashboard (확인사항 공유 메모)
  //    { checklist: string }
  // =========================
  const tbody = document.getElementById('tbody');
  const top3El = document.getElementById('top3');
  const bottom3El = document.getElementById('bottom3');
  const kpiProgressEl = document.getElementById('kpiProgress');
  const kpiParcelsEl = document.getElementById('kpiParcels');
  const checklistEl = document.getElementById('checklist');

  let latestProjects = [];

  if(db){
    // 실시간 구독: projects
    unsubscribeProjects = db.collection('projects').orderBy('team').orderBy('name').onSnapshot(snap => {
      latestProjects = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      renderProjects(latestProjects);
      renderDashboard(latestProjects);
    });

    // 실시간 구독: 확인사항 메모
    db.collection('settings').doc('dashboard').onSnapshot(doc => {
      const d = doc.data() || {};
      checklistEl.value = d.checklist || '';
    });
  } else {
    // Firebase 없는 경우: 예시 데이터 화면 표시
    latestProjects = [
      {id:'EX1', name:'A-1지구', team:'1팀', total:100, completed:42, completed_last_week:35, lxNotes:'예시 메모', authorityFeedback:'예시 피드백'},
      {id:'EX2', name:'B-2지구', team:'1팀', total:80, completed:68, completed_last_week:60, lxNotes:'', authorityFeedback:''},
      {id:'EX3', name:'C-1지구', team:'2팀', total:120, completed:25, completed_last_week:25, lxNotes:'', authorityFeedback:''},
      {id:'EX4', name:'D-5지구', team:'2팀', total:60, completed:55, completed_last_week:40, lxNotes:'', authorityFeedback:''},
      {id:'EX5', name:'E-3지구', team:'3팀', total:90, completed:10, completed_last_week:9, lxNotes:'', authorityFeedback:''},
    ];
    renderProjects(latestProjects);
    renderDashboard(latestProjects);
    checklistEl.value = '데모 모드입니다. Firebase 연결 시 실시간 공유됩니다.';
    checklistEl.disabled = true;
  }

  checklistEl.addEventListener('input', debounce(async ()=>{
    if(!(auth && currentUser && db)) return; // 비로그인 시 무시
    try{
      await db.collection('settings').doc('dashboard').set({ checklist: checklistEl.value, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    }catch(e){ console.error(e); }
  }, 600));

  function pct(completed,total){
    const p = (!total||total<=0) ? 0 : (completed/total*100);
    return Math.round(p*10)/10; // 0.1 단위 반올림
  }

  function renderDashboard(rows){
    // KPI
    const totalAll = rows.reduce((s,r)=>s+(Number(r.total)||0),0);
    const doneAll  = rows.reduce((s,r)=>s+(Number(r.completed)||0),0);
    const progress = pct(doneAll,totalAll);
    kpiProgressEl.textContent = progress.toFixed(1) + '%';
    kpiParcelsEl.textContent = `${doneAll} / ${totalAll} 필지`;

    // 도넛 (높이 절반)
    const remain = Math.max(0,totalAll-doneAll);
    const data = { labels:['완료','잔여'], datasets:[{ data:[doneAll, remain] }] };
    const opt = { plugins:{ legend:{ labels:{ color:'#cfe0ff' } } }, scales:{} };
    const ctx = document.getElementById('overallDonut');
    if(donutChart){ donutChart.data = data; donutChart.update(); }
    else { donutChart = new Chart(ctx,{ type:'doughnut', data, options:opt }); }

    // Top/Bottom 3
    const withPct = rows.map(r=> ({...r, p:pct(Number(r.completed)||0, Number(r.total)||0)}));
    const valid = withPct.filter(r=> (Number(r.total)||0)>0);
    valid.sort((a,b)=>b.p - a.p);
    const top = valid.slice(0,3);
    const bottom = valid.slice(-3).reverse();
    top3El.innerHTML = top.map(r=>`<li>${r.name} <span class="muted">(${r.p.toFixed(1)}%)</span></li>`).join('');
    bottom3El.innerHTML = bottom.map(r=>`<li>${r.name} <span class="muted">(${r.p.toFixed(1)}%)</span></li>`).join('');
  }

  function renderProjects(rows){
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    rows.forEach(r => {
      const total = Number(r.total)||0;
      const comp  = Number(r.completed)||0;
      const last  = Number(r.completed_last_week)||0;
      const pNow  = pct(comp,total);
      const pPrev = pct(last,total);
      const diff  = Math.round((pNow - pPrev)*10)/10; // pp
      const changed = Math.abs(diff) > 0.0001;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(r.team||'')}</td>
        <td>${esc(r.name||'')}</td>
        <td>
          <input type=\"number\" class=\"in-total\" data-id=\"${r.id}\" value=\"${total}\" ${editableAttr()} />
        </td>
        <td>
          <input type=\"number\" class=\"in-completed\" data-id=\"${r.id}\" value=\"${comp}\" ${editableAttr()} />
        </td>
        <td>${pNow.toFixed(1)}%</td>
        <td class=\"delta ${changed? 'changed':''}\">${changed? (diff>0?'+':'')+diff.toFixed(1) : '—'}</td>
        <td>
          <textarea class=\"in-lx\" data-id=\"${r.id}\" ${editableAttr()}>${esc(r.lxNotes||'')}</textarea>
        </td>
        <td>
          <textarea class=\"in-auth\" data-id=\"${r.id}\" ${editableAttr()}>${esc(r.authorityFeedback||'')}</textarea>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // 이벤트 바인딩 (debounce)
    tbody.querySelectorAll('.in-total').forEach(el=>{
      el.addEventListener('input', debounce(e=> saveField(e.target,'total', toNum(e.target.value)), 500));
    });
    tbody.querySelectorAll('.in-completed').forEach(el=>{
      el.addEventListener('input', debounce(e=> saveField(e.target,'completed', toNum(e.target.value)), 500));
    });
    tbody.querySelectorAll('.in-lx').forEach(el=>{
      el.addEventListener('input', debounce(e=> saveField(e.target,'lxNotes', e.target.value), 700));
    });
    tbody.querySelectorAll('.in-auth').forEach(el=>{
      el.addEventListener('input', debounce(e=> saveField(e.target,'authorityFeedback', e.target.value), 700));
    });
  }

  function editableAttr(){
    return (auth && currentUser) ? '' : 'disabled';
  }

  function toNum(v){
    const n = Number(v);
    return isFinite(n) ? n : 0;
  }

  function esc(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }

  async function saveField(el, field, value){
    if(!(auth && currentUser && db)) return; // 비로그인 시 무시
    const id = el.getAttribute('data-id');
    try{
      await db.collection('projects').doc(id).update({ [field]: value, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    }catch(e){ alert('저장 실패: '+ e.message); }
  }

  // =========================
  // 4) 관리자 도구: 새 주 시작 / 추가 / 샘플 / CSV
  // =========================
  document.getElementById('btnNewWeek').addEventListener('click', async () => {
    if(!(auth && currentUser && db)) return alert('로그인 필요');
    if(!confirm('모든 사업지구의 "지난 주 완료" 값을 이번 주 완료 값으로 이월합니다. 진행할까요?')) return;
    const snap = await db.collection('projects').get();
    const batch = db.batch();
    snap.forEach(doc => {
      const d = doc.data();
      batch.update(doc.ref, { completed_last_week: Number(d.completed)||0, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    });
    await batch.commit();
    alert('새 주가 시작되었습니다. (지난 주 값 이월 완료)');
  });

  document.getElementById('btnAddProject').addEventListener('click', async () => {
    if(!(auth && currentUser && db)) return alert('로그인 필요');
    const name = document.getElementById('inName').value.trim();
    const team = document.getElementById('inTeam').value.trim();
    const total = toNum(document.getElementById('inTotal').value);
    const completed = toNum(document.getElementById('inCompleted').value);
    if(!name || !team) return alert('사업지구명과 팀을 입력하세요.');
    try{
      await db.collection('projects').add({
        name, team, total, completed, completed_last_week: completed,
        lxNotes:'', authorityFeedback:'',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById('inName').value='';
      document.getElementById('inTeam').value='';
      document.getElementById('inTotal').value='';
      document.getElementById('inCompleted').value='';
    }catch(e){ alert('추가 실패: '+e.message); }
  });

  document.getElementById('btnAddSample').addEventListener('click', async () => {
    if(!(auth && currentUser && db)) return alert('로그인 필요');
    const samples = [
      {name:'제주-서부1지구', team:'A팀', total:140, completed:90},
      {name:'제주-서부2지구', team:'A팀', total:110, completed:45},
      {name:'제주-북부지구',  team:'B팀', total:95,  completed:80},
      {name:'제주-중산간지구',team:'B팀', total:200, completed:60},
      {name:'제주-서귀포지구',team:'C팀', total:150, completed:15},
    ];
    const batch = db.batch();
    const col = db.collection('projects');
    samples.forEach(s => {
      const ref = col.doc();
      batch.set(ref, {
        ...s,
        completed_last_week: s.completed,
        lxNotes:'', authorityFeedback:'',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    await batch.commit();
    alert('샘플 데이터가 추가되었습니다.');
  });

  document.getElementById('btnExport').addEventListener('click', () => {
    exportCSV(latestProjects);
  });

  function exportCSV(rows){
    const headers = ['team','name','total','completed','completed_last_week','progress_now','progress_prev','delta_pp','lxNotes','authorityFeedback'];
    const lines = [headers.join(',')];
    rows.forEach(r => {
      const total = Number(r.total)||0, comp=Number(r.completed)||0, last=Number(r.completed_last_week)||0;
      const pNow=pct(comp,total), pPrev=pct(last,total), d=(pNow-pPrev).toFixed(1);
      const vals = [r.team||'', r.name||'', total, comp, last, pNow.toFixed(1), pPrev.toFixed(1), d, quote(r.lxNotes||''), quote(r.authorityFeedback||'')];
      lines.push(vals.join(','));
    });
    const blob = new Blob(["﻿" + lines.join('
')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='projects.csv'; a.click();
    URL.revokeObjectURL(url);
  }
  function quote(s){
    const t = String(s).replaceAll('"','""');
    return '"'+t+'"';
  }

  // =========================
  // 5) 유틸: debounce
  // =========================
  function debounce(fn, wait){
    let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
  }
  </script>
</body>
</html>
