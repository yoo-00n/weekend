<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ì¬ì¡°ì‚¬ Weekly</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header>
    <div class="wrap flex" style="padding:12px 20px">
      <div class="flex" style="gap:10px">
        <span class="tag">ë‚¨ì›ì‹œ ì§€ì ì¬ì¡°ì‚¬ì‚¬ì—… í˜‘ì˜ìœ¨ ëŒ€ì‹œë³´ë“œ</span>
      </div>
      <div class="spacer"></div>
      <div class="flex">
        <span id="userInfo" class="muted">ë¡œê·¸ì¸ í•„ìš”</span>
        <span id="roleBadge" class="badge hidden"></span>
        <button id="btnSignIn" class="btn">ë¡œê·¸ì¸</button>
        <button id="btnSignOut" class="btn hidden">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:16px">
    <a href="https://yoo-00n.github.io/JAJOSA/" target="_blank" class="floating-banner">
      <img src="https://raw.githubusercontent.com/yoo-00n/weekend/main/docs/banner.png" alt="ê²½ê³„í˜‘ì˜ì„œ Beta">
      <div class="banner-icon">ğŸ“ ê²½ê³„í˜‘ì˜ì„œ <b>Beta</b></div>
    </a>
    </aside>

    <section class="main">

      <div class="dash">
        <div class="card">
          <div class="pad">
            <h2>ì „ì²´ ê³µì •ë¥ </h2>
            <div class="kpi">
              <span id="kpiProgress" class="big">0%</span>
              <span class="sub" id="kpiParcels">0 / 0 í•„ì§€</span>
            </div>
            <canvas id="overallDonut" style="margin-top:6px"></canvas>
          </div>
        </div>

        <div class="dash-right">
          <div class="card">
            <div class="pad">
              <h2>Top 3</h2>
              <ol id="top3" class="muted" style="padding-left:18px;margin:0"></ol>
              <div class="footer">ì§„í–‰ë¥ (%) ê¸°ì¤€</div>
            </div>
          </div>
          <div class="card">
            <div class="pad">
              <h2>Bottom 3</h2>
              <ol id="bottom3" class="muted" style="padding-left:18px;margin:0"></ol>
              <div class="footer">ì§„í–‰ë¥ (%) ê¸°ì¤€</div>
            </div>
          </div>

          <!-- NOTICE -->
          <div class="card span-2">
            <div class="pad">
              <h2>NOTICE</h2>
              <textarea id="checklist" placeholder="ì˜ˆ: ìë£Œ ë³´ì™„ ëŒ€ìƒ ì§€êµ¬, ì¼ì • ë“±" disabled></textarea>
              <div id="checklistStatus" class="footer muted">ì½ê¸° ì „ìš©</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="pad">
          <h2>ê´€ë¦¬ ë„êµ¬</h2>

          <div class="tools-layout">
            <section>
              <div class="btn-row" style="margin-bottom:10px">
                <button id="btnNewWeek" class="btn" disabled>ìƒˆ ì£¼ ì‹œì‘(ì§€ë‚œ ì£¼ ì´ì›”)</button>
                <button id="btnAddSample" class="btn accent" disabled>ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€</button>
                <button id="btnExport" class="btn">CSV ë‚´ë³´ë‚´ê¸°</button>
                <button id="btnRequestEdit" class="btn">í¸ì§‘ ê¶Œí•œ ìš”ì²­</button>
                <button id="btnDeleteAll" class="btn danger hidden">ì „ì²´ ì‚­ì œ(ê´€ë¦¬ì)</button>
              </div>

              <div class="row cols-2">
                <div>
                  <h3 style="margin:0 0 8px 0;color:#cfe0ff;font-size:14px">ì‚¬ì—…ì§€êµ¬ ì¶”ê°€</h3>
                  <div class="row cols-2">
                    <input id="inName" type="text" placeholder="ì‚¬ì—…ì§€êµ¬ëª…" />
                    <input id="inTeam" type="text" placeholder="ë‹´ë‹¹íŒ€" />
                  </div>
                  <div class="row cols-2" style="margin-top:8px">
                    <input id="inTotal" type="number" placeholder="ì´ í•„ì§€" />
                    <input id="inCompleted" type="number" placeholder="ì™„ë£Œ(ì´ë²ˆ ì£¼)" />
                  </div>
                  <div class="btn-row" style="margin-top:8px">
                    <button id="btnAddProject" class="btn" disabled>ì¶”ê°€</button>
                  </div>
                  <div class="footer">â€» ADMINë§Œ ì¶”ê°€/ì‚­ì œ ê°€ëŠ¥. Î”ëŠ” ì§€ë‚œ ì£¼ ëŒ€ë¹„ ë³€í™”(pp).</div>
                  <div class="footer">â€» lx - ê³µì •ë¥ , ì¼ì • í¸ì§‘ ê°€ëŠ¥</div>
                  <div class="footer">â€» namwon - ì¼ì • í¸ì§‘ ê°€ëŠ¥</div>
                </div>

                <div>
                  <h3 style="margin:0 0 8px 0;color:#cfe0ff;font-size:14px">ë‚¨ì›ì‹œì²­</h3>
                  <ul class="muted" style="margin:0 0 6px 16px;padding:0">
                    <li>1íŒ€ : ê¹€ìš©ìˆ˜, ê¹€ë‘ë¦¬</li>
                    <li>2íŒ€ : ì´ëŒ€ì—°, ì´ìŠ¹ì›</li>
                    <li>3íŒ€ : ê¹€êµ­í™˜, ë…¸ì‹œì¤€</li>
                  </ul>
                  <h3 style="margin:0 0 8px 0;color:#cfe0ff;font-size:14px">LX</h3>
                  <ul class="muted" style="margin:0 0 6px 16px;padding:0">
                    <li>ë‚˜ì •í™˜ : ì‚¬ì„/ë„ë‘/ì‚¬ë§¤2/ì†¡ë‚´/ê°•ì„</li>
                    <li>ì´ê·¼í–‰ : í˜¸ê³¡/í‰ì´Œ/ì˜¥ì „</li>
                    <li>ê¹€í˜•ìœ¤ : ë¶€ì ˆ/ì„œê³¡</li>
                    <li>ë°•ê´‘í›ˆ : í˜¸ê²½/ë‚´ê¸°</li>
                  </ul>
                </div>
              </div>
            </section>

            <aside class="calendar-box">
              <div id="calendar"></div>
            </aside>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="pad">
          <h2>ë‹´ë‹¹íŒ€ë³„ ì‚¬ì—…ì§€êµ¬ í˜„í™©</h2>
          <table>
            <thead>
              <tr>
                <th class="col-team">
                  ë‹´ë‹¹íŒ€
                  <select id="teamFilter" style="margin-left:.5rem;max-width:120px">
                    <option value="__ALL__">ì „ì²´</option>
                  </select>
                </th>
                <th class="col-name">ì‚¬ì—…ì§€êµ¬</th>
                <th class="col-total">ì´ í•„ì§€</th>
                <th class="col-done">ì™„ë£Œ (ì´ë²ˆ ì£¼)</th>
                <th class="col-progress">ê³µì •ë¥  (%)</th>
                <th class="col-delta">Î” ì£¼ê°„ (pp)</th>
                <th class="col-handover">LX ì „ë‹¬ì‚¬í•­</th>
                <th class="col-feedback">ì†Œê´€ì²­ í”¼ë“œë°±</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <div id="adminPanel" class="card hidden" style="margin-top:16px">
        <div class="pad">
          <h2>ê´€ë¦¬ì íŒ¨ë„ Â· ê¶Œí•œ ìŠ¹ì¸</h2>
          <div class="footer">ì—¬ê¸° ë³´ì´ëŠ” í•­ëª©ì€ <b>role=admin</b> ì‚¬ìš©ìì—ê²Œë§Œ í‘œì‹œë©ë‹ˆë‹¤.</div>
          <h3 style="color:#cfe0ff;margin-top:12px">ìŠ¹ì¸ ëŒ€ê¸° ìš”ì²­</h3>
          <div id="requests"></div>
          <h3 style="color:#cfe0ff;margin-top:12px">í˜„ì¬ ê¶Œí•œ ì‚¬ìš©ì</h3>
          <div id="editors"></div>
        </div>
      </div>

    </section>
    <!-- /ìš°ì¸¡ ì½˜í…ì¸  -->
    </div>
  </main>



  <script>
    /* ========= 1) Firebase ì„¤ì • ========= */
    const firebaseConfig = {
      apiKey: "AIzaSyBDQSpN1_hV5cj9wDHqzxwIEfWHUsuMEu0",
      authDomain: "weekend-6d16d.firebaseapp.com",
      projectId: "weekend-6d16d",
      storageBucket: "weekend-6d16d.appspot.com",
      messagingSenderId: "399772383646",
      appId: "1:399772383646:web:21208b83404479669c3e8f",
      measurementId: "G-35FK2FRMBZ"
    };
    const USER_DOMAIN = "acct.lx.local";

    /* ========= 2) ì´ˆê¸°í™” ========= */
    const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // NOTICE ë¬¸ì„œ ref
    const dashboardRef = db.collection("settings").doc("dashboard");

    // KPI ë¬¸ì„œ ref (ê²Œì´ì§€ìš©)
    const projIdForKPI = 'global';
    const statsRef = db.doc(`projects/${projIdForKPI}/stats/kpis`);

    let donutChart = null;
    let currentUser = null;
    let role = null;         // "admin" | "lx" | "namwon" | null
    let isEditor = false;
    let isAdmin = false;

    /* ========= 3) ì¸ì¦ ========= */
    const btnSignIn = document.getElementById("btnSignIn");
    const btnSignOut = document.getElementById("btnSignOut");
    const userInfo = document.getElementById("userInfo");
    theRoleBadge = document.getElementById("roleBadge");
    const roleBadge = theRoleBadge;
    const adminPanel = document.getElementById("adminPanel");
    const btnDeleteAll = document.getElementById("btnDeleteAll");

    let unsubs = [];
    function clearDataStreams() { unsubs.forEach(u => u && u()); unsubs = []; }

    function bindDataStreams() {
      clearDataStreams();
      if (!db || !currentUser) return;

      // 1) projects ì‹¤ì‹œê°„
      unsubs.push(
        db.collection("projects").orderBy("team").onSnapshot((snap) => {
          latestProjects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          latestProjects.sort((a, b) =>
            String(a.team || "").localeCompare(String(b.team || "")) ||
            String(a.name || "").localeCompare(String(b.name || ""))
          );
          renderProjects(latestProjects);
          renderDashboardFromRows(latestProjects);
          recomputeAndPushStats(latestProjects).catch(console.warn);
          buildTeamFilter(latestProjects);
          applyTeamFilter();
        }, (err) => { console.warn("projects listen error:", err.code || err.message); })
      );

      // 2) KPI(stats/kpis) ì‹¤ì‹œê°„
      unsubs.push(
        statsRef.onSnapshot((snap) => {
          if (!snap.exists) {
            statsRef.set({ total: 0, done: 0, weekComplete: 0 }, { merge: true });
            return;
          }
          const s = snap.data() || {};
          updateGauge(Number(s.done) || 0, Number(s.total) || 0);
        }, (err) => console.warn("stats listen error:", err.code || err.message))
      );

      // 3) settings/dashboard ì‹¤ì‹œê°„ â†’ NOTICE í‘œì‹œ
      unsubs.push(
        dashboardRef.onSnapshot(doc => {
          const d = doc.data() || {};
          if (checklistEl && document.activeElement !== checklistEl) {
            checklistEl.value = d.checklist || "";
          }
        }, (err) => { console.warn("settings listen error:", err.code || err.message); })
      );
    }

    if (auth) {
      auth.onAuthStateChanged(async (user) => {
        currentUser = user;
        if (user) {
          const idLike = user.email ? user.email.split("@")[0] : user.uid.slice(0, 6);
          userInfo.textContent = `${idLike} ì ‘ì†`;
          btnSignIn.classList.add("hidden");
          btnSignOut.classList.remove("hidden");

          await refreshRole();
          setControlsEnabled();
          bindDataStreams();
          initCalendar();
          bindCalendarStreams();
        } else {
          userInfo.textContent = "ë¡œê·¸ì¸ í•„ìš”";
          btnSignIn.classList.remove("hidden");
          btnSignOut.classList.add("hidden");
          roleBadge.classList.add("hidden");
          role = null; isEditor = false; isAdmin = false;
          setControlsEnabled();
          clearDataStreams();
          latestProjects = [];
          renderProjects(latestProjects);
          renderDashboardFromRows(latestProjects);
          initCalendar();
          bindCalendarStreams();
        }
      });

      btnSignIn.addEventListener("click", async () => {
        try {
          const username = prompt("ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ADMIN, LX, NAMWON)");
          if (!username) return;
          const password = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
          if (!password) return;
          const email = `${username.trim()}@${USER_DOMAIN}`;
          await auth.signInWithEmailAndPassword(email, password);
        } catch (e) { alert(`[ë¡œê·¸ì¸ ì‹¤íŒ¨] ${e.code || ""} ${e.message || e}`); }
      });
      btnSignOut.addEventListener("click", async () => { await auth.signOut(); });
    }

    async function refreshRole() {
      role = null; isEditor = false; isAdmin = false;
      if (!(db && currentUser)) return;
      const r = await db.collection("roles").doc(currentUser.uid).get();
      if (r.exists) {
        role = String(r.data().role || "").toLowerCase();
        isAdmin = role === "admin";
        isEditor = role === "admin" || role === "lx";
        roleBadge.textContent = role || "unknown";
        roleBadge.classList.remove("hidden");
        if (isAdmin) {
          adminPanel?.classList.remove("hidden");
          btnDeleteAll?.classList.remove("hidden");
          bindAdminStreams();
        } else {
          adminPanel?.classList.add("hidden");
          btnDeleteAll?.classList.add("hidden");
          clearAdminStreams();
        }
      } else {
        roleBadge.textContent = "no-role";
        roleBadge.classList.remove("hidden");
        adminPanel?.classList.add("hidden");
        btnDeleteAll?.classList.add("hidden");
      }
    }

    function setControlsEnabled() {
      setDisabled("btnNewWeek", !(currentUser && isAdmin));
      setDisabled("btnAddProject", !(currentUser && isAdmin));
      setDisabled("btnAddSample", !(currentUser && isAdmin));
      if (checklistEl) {
        const editable = !!(currentUser && isAdmin);
        checklistEl.disabled = !editable;
        checklistStatus.textContent = editable ? "ìë™ ì €ì¥(ê´€ë¦¬ì)" : "ì½ê¸° ì „ìš©";
      }
      renderProjects(latestProjects);
    }
    function setDisabled(id, yes) {
      const el = document.getElementById(id);
      if (el) el.disabled = !!yes;
    }

    /* ========= 4) ë°ì´í„° ========= */
    const tbody = document.getElementById("tbody");
    const top3El = document.getElementById("top3");
    const bottom3El = document.getElementById("bottom3");
    const kpiProgressEl = document.getElementById("kpiProgress");
    const kpiParcelsEl = document.getElementById("kpiParcels");
    const checklistEl = document.getElementById("checklist");
    const checklistStatus = document.getElementById("checklistStatus");
    const teamFilterEl = document.getElementById("teamFilter");

    let latestProjects = [];

    /* ========= 5) ë Œë”/ê³„ì‚° ========= */
    function pct1(completed, total) {
      const p = (!total || total <= 0) ? 0 : (completed / total * 100);
      return Math.round(p * 10) / 10;
    }
    function pctInt(completed, total) {
      const p = (!total || total <= 0) ? 0 : (completed / total * 100);
      return Math.round(p);
    }
    function pctSafe(done, total) {
      const dn = Number(done), tn = Number(total);
      if (!Number.isFinite(dn) || !Number.isFinite(tn) || tn <= 0) return 0;
      return (dn / tn) * 100;
    }

    function updateGauge(doneAll, totalAll) {
      const progress = pct1(doneAll, totalAll);
      kpiProgressEl.textContent = progress.toFixed(1) + "%";
      kpiParcelsEl.textContent = `${doneAll} / ${totalAll} í•„ì§€`;

      const remain = Math.max(0, totalAll - doneAll);
      const data = {
        labels: ["ì™„ë£Œ", "ì”ì—¬"],
        datasets: [{ data: [doneAll, remain] }]
      };
      const opt = {
        plugins: { legend: { labels: { color: "#cfe0ff" } } },
        cutout: "60%",
        maintainAspectRatio: false,
        layout: { padding: 0 }
      };
      const ctx = document.getElementById("overallDonut");
      if (donutChart) {
        donutChart.data = data;
        donutChart.update();
      } else {
        donutChart = new Chart(ctx, { type: "doughnut", data, options: opt });
      }
    }

    /* Top/Bottom ê³„ì‚°: completed/total ê¸°ë°˜ */
    function renderDashboardFromRows(rows) {
      const withPct = rows
        .map(r => {
          const p = pct1(Number(r.completed) || 0, Number(r.total) || 0);
          return { ...r, p };
        })
        .filter(r => (Number(r.total) || 0) > 0)
        .sort((a, b) => b.p - a.p);

      const top = withPct.slice(0, 3);
      const bottom = withPct.slice(-3).reverse();

      top3El.innerHTML = top
        .map(r => `<li>${esc(r.name)} <span class="muted">(${r.p.toFixed(1)}%)</span></li>`)
        .join("");
      bottom3El.innerHTML = bottom
        .map(r => `<li>${esc(r.name)} <span class="muted">(${r.p.toFixed(1)}%)</span></li>`)
        .join("");
    }

    async function recomputeAndPushStats(rows) {
      const totalAll = rows.reduce((s, r) => s + (Number(r.total) || 0), 0);
      const doneAll = rows.reduce((s, r) => s + (Number(r.completed) || 0), 0);
      try {
        await safeSet(statsRef, {
          total: totalAll,
          done: doneAll,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: auth.currentUser ? auth.currentUser.uid : null,
        });
      } catch (e) {
        console.debug('stats push skipped:', e.code || e.message);
      }
    }

    /* í…Œì´ë¸” ë Œë”: ì§„í–‰ë¥ /Î” ê³„ì‚° */
    function renderProjects(rows) {
      if (!tbody) return;
      tbody.innerHTML = "";

      rows.forEach(r => {
        // ì´ë²ˆ ì£¼ ê°’
        const total = Number(r.total) || 0;
        const comp = Number(r.completed) || 0;

        // ì§€ë‚œ ì£¼ ê°’ (ì—†ìœ¼ë©´ ì´ë²ˆ ì£¼ ê°’ìœ¼ë¡œ fallback)
        const last = Number(
          r.completed_last_week ?? r.completed ?? 0
        );
        const lastTotal = Number(
          (r.total_last_week ?? r.total ?? 0)
        );

        // ì§„í–‰ë¥ (ì´ë²ˆ ì£¼ / ì§€ë‚œ ì£¼)
        const hasNowPct = (typeof r.progress === "number" && Number.isFinite(r.progress));
        const hasPrevPct = (typeof r.progress_last_week === "number" && Number.isFinite(r.progress_last_week));

        // pNow: ì´ë²ˆ ì£¼ ì§„í–‰ë¥ (%)
        const pNow = hasNowPct
          ? Number(r.progress)
          : pctSafe(comp, total);

        // pPrev: ì§€ë‚œ ì£¼ ì§„í–‰ë¥ (%)
        // ê¸°ë³¸ì ìœ¼ë¡œ progress_last_week > fallback(ì§€ë‚œì£¼ ì™„ë£Œ/ì´í•„ì§€) > ìµœí›„ì—ëŠ” ì´ë²ˆ ì£¼ë‘ ê°™ê²Œ
        let pPrev = hasPrevPct
          ? Number(r.progress_last_week)
          : pctSafe(last, lastTotal);

        if (!Number.isFinite(pPrev)) {
          pPrev = pNow;
        }

        // ì§€ë‚œì£¼ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ë¥¼ ë„ˆë¬´ ë¹¡ì„¸ê²Œ ë³´ì§€ ë§ê³ 
        // pPrevê°€ ìœ íš¨í•˜ë©´ ìˆë‹¤ê³  ì¹˜ì
        const hasPrevData = Number.isFinite(pPrev);

        // Î” ê³„ì‚°
        let diff = pNow - pPrev;
        diff = Number.isFinite(diff) ? Math.round(diff * 10) / 10 : 0;

        const changed = hasPrevData && Math.abs(diff) >= 0.1;
        const pInt = Math.max(0, Math.min(100, Math.round(pNow)));

        const deltaCell = hasPrevData
          ? (changed ? (diff > 0 ? "+" : "") + diff.toFixed(1) : "0.0")
          : "â€”";

        const tr = document.createElement("tr");
        tr.dataset.team = r.team || "";
        tr.innerHTML = `
      <td class="col-team">${esc(r.team || "")}</td>
      <td class="col-name">
        ${esc(r.name || "")}
        ${isAdmin ? ` <button class="btn danger btn-xs" data-del="${r.id}">ì‚­ì œ</button>` : ""}
      </td>
      <td class="col-total">
        <input type="number" class="in-total" data-id="${r.id}" value="${total}" ${isAdmin ? "" : "disabled"} />
      </td>
      <td class="col-done">
        <input type="number" class="in-completed" data-id="${r.id}" value="${comp}" ${(isAdmin || role === "lx") ? "" : "disabled"} />
      </td>
      <td class="col-progress">
        <div class="barwrap">
          <div class="bar" style="width:${Math.max(0, Math.min(100, pInt))}%"></div>
          <span class="barlabel">${pInt}%</span>
        </div>
      </td>
      <td class="col-delta delta ${hasPrevData && changed ? "changed" : ""}">${deltaCell}</td>
      <td class="col-handover">
        <textarea class="in-lx" data-id="${r.id}" ${(isAdmin || role === "lx") ? "" : "disabled"}>${esc(r.lx_note || r.lxNotes || "")}</textarea>
      </td>
      <td class="col-feedback">
        <textarea class="in-auth" data-id="${r.id}" ${isAdmin ? "" : "disabled"}>${esc(r.authorityFeedback || "")}</textarea>
      </td>
    `;
        tbody.appendChild(tr);
      });

      // ì´ë²¤íŠ¸ ë°”ì¸ë”© (ê·¸ëŒ€ë¡œ ìœ ì§€)
      tbody.querySelectorAll(".in-completed").forEach(el => {
        if (isAdmin) {
          el.addEventListener("input", debounce(e => {
            saveFieldRoot(e.target, "completed", toNum(e.target.value));
          }, 500));
        } else if (role === "lx") {
          el.addEventListener("input", debounce(e => {
            const tr = e.target.closest("tr");
            const total = toNum(tr.querySelector(".in-total")?.value);
            const completedCount = toNum(e.target.value);
            const percent = (!total || total <= 0) ? 0 : (completedCount / total * 100);
            const pInt = Math.max(0, Math.min(100, Math.round(percent)));
            const projId = e.target.getAttribute("data-id");
            saveCompletedAndProgress(projId, completedCount, pInt);
          }, 600));
        }
      });

      tbody.querySelectorAll(".in-lx").forEach(el => {
        if (!(isAdmin || role === "lx")) return;
        el.addEventListener("input", debounce(e => {
          saveFieldRoot(e.target, "lx_note", e.target.value);
        }, 700));
      });

      tbody.querySelectorAll(".in-auth").forEach(el => {
        if (!isAdmin) return;
        el.addEventListener("input", debounce(e => {
          saveFieldRoot(e.target, "authorityFeedback", e.target.value);
        }, 700));
      });

      if (isAdmin) {
        tbody.querySelectorAll("[data-del]").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.getAttribute("data-del");
            if (!id) return;
            if (!confirm("ì´ ì‚¬ì—…ì§€êµ¬ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
            try {
              await db.collection("projects").doc(id).delete();
            } catch (err) {
              alert("ì‚­ì œ ì‹¤íŒ¨: " + (err.message || err));
            }
          });
        });
      }
    }


    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    tbody.querySelectorAll(".in-completed").forEach(el => {
      if (isAdmin) {
        el.addEventListener("input", debounce(e => {
          saveFieldRoot(e.target, "completed", toNum(e.target.value));
        }, 500));
      } else if (role === "lx") {
        el.addEventListener("input", debounce(e => {
          const tr = e.target.closest("tr");
          const total = toNum(tr.querySelector(".in-total")?.value);
          const completedCount = toNum(e.target.value);
          const percent = (!total || total <= 0) ? 0 : (completedCount / total * 100);
          const pInt = Math.max(0, Math.min(100, Math.round(percent)));
          const projId = e.target.getAttribute("data-id");
          saveCompletedAndProgress(projId, completedCount, pInt);
        }, 600));
      }
    });

    tbody.querySelectorAll(".in-lx").forEach(el => {
      if (!(isAdmin || role === "lx")) return;
      el.addEventListener("input", debounce(e => {
        saveFieldRoot(e.target, "lx_note", e.target.value);
      }, 700));
    });

    tbody.querySelectorAll(".in-auth").forEach(el => {
      if (!isAdmin) return;
      el.addEventListener("input", debounce(e => {
        saveFieldRoot(e.target, "authorityFeedback", e.target.value);
      }, 700));
    });

    if (isAdmin) {
      tbody.querySelectorAll("[data-del]").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const id = e.currentTarget.getAttribute("data-del");
          if (!id) return;
          if (!confirm("ì´ ì‚¬ì—…ì§€êµ¬ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
          try {
            await db.collection("projects").doc(id).delete();
          } catch (err) {
            alert("ì‚­ì œ ì‹¤íŒ¨: " + (err.message || err));
          }
        });
      });
    }

    function toNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }
    function esc(s) {
      return String(s).replace(/[&<>\"']/g, c => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        "\"": "&quot;",
        "'": "&#39;"
      }[c]));
    }

    // ì•ˆì „ ì €ì¥ ìœ í‹¸
    async function safeSet(ref, data, opt = { merge: true }) {
      console.log('[WRITE:set]', ref.path, data);
      try {
        await ref.set(data, opt);
        console.log('[OK:set]', ref.path);
      } catch (e) {
        console.error('[FAIL:set]', ref.path, data, e.code, e.message);
        throw e;
      }
    }
    async function safeUpdate(ref, data) {
      console.log('[WRITE:update]', ref.path, data);
      try {
        await ref.update(data);
        console.log('[OK:update]', ref.path);
      } catch (e) {
        console.error('[FAIL:update]', ref.path, data, e.code, e.message);
        throw e;
      }
    }

    // ë£¨íŠ¸ ë¬¸ì„œ í•„ë“œ ì €ì¥
    async function saveFieldRoot(el, field, value) {
      if (!(auth && currentUser && db)) return;
      const id = el.getAttribute("data-id");
      const ref = db.collection("projects").doc(id);
      const patch = (field === "lx_note")
        ? { lx_note: String(value) }
        : { [field]: value };

      try {
        await safeUpdate(ref, {
          ...patch,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: currentUser.uid
        });
      } catch (e) {
        if (e.code === "not-found" || /NOT_FOUND/i.test(String(e.message))) {
          await safeSet(ref, {
            ...patch,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser.uid
          }, { merge: true });
        } else if (e.code === "permission-denied") {
          alert("í¸ì§‘ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ì ìŠ¹ì¸/ê¶Œí•œ í•„ìš”)");
          return;
        } else {
          alert("ì €ì¥ ì‹¤íŒ¨: " + (e.message || e));
          return;
        }
      }

      // ğŸ”¥ ë¡œì»¬ latestProjectsì—ë„ ë°˜ì˜í•´ì„œ ì¦‰ì‹œ ì¬ë Œë”
      const idx = latestProjects.findIndex(p => p.id === id);
      if (idx >= 0) {
        latestProjects[idx] = {
          ...latestProjects[idx],
          ...patch,
        };
      }
      renderProjects(latestProjects);
      renderDashboardFromRows(latestProjects);
      recomputeAndPushStats(latestProjects).catch(console.warn);
    }


    // LX ì €ì¥ (ì§€ë‚œ ì£¼ ìŠ¤ëƒ…ìƒ·ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
    async function saveCompletedAndProgress(projectId, completedCount, percentInt) {
      if (!(auth && currentUser && db)) return;

      const done = Number(completedCount);
      const p = Number(percentInt);
      if (!Number.isFinite(done) || done < 0) {
        alert("ì™„ë£Œ(ì´ë²ˆ ì£¼)ëŠ” 0 ì´ìƒ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }
      if (!Number.isFinite(p) || p < 0 || p > 100) {
        alert("ì§„í–‰ë¥ ì€ 0~100 ì‚¬ì´ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }

      const today = new Date().toISOString().slice(0, 10);
      const projRef = db.collection("projects").doc(projectId);

      // progress ì„œë¸Œì½œë ‰ì…˜ì— ê¸°ë¡
      await safeSet(
        projRef.collection("progress").doc(today),
        {
          progress: p,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: currentUser.uid
        },
        { merge: true }
      );

      // ë£¨íŠ¸ ë¬¸ì„œì—ë„ ë°˜ì˜
      await safeUpdate(projRef, {
        completed: done,
        progress: p,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser.uid
      });

      // ğŸ”¥ ë¡œì»¬ latestProjectsì—ë„ ì¦‰ì‹œ ë°˜ì˜
      const idx = latestProjects.findIndex(prj => prj.id === projectId);
      if (idx >= 0) {
        latestProjects[idx] = {
          ...latestProjects[idx],
          completed: done,
          progress: p
        };
      }

      // ë‹¤ì‹œ ê·¸ë¦¬ê¸° (Î” í¬í•¨)
      renderProjects(latestProjects);
      renderDashboardFromRows(latestProjects);
      recomputeAndPushStats(latestProjects).catch(console.warn);
    }


    // NOTICE ìë™ ì €ì¥ (adminë§Œ)
    checklistEl?.addEventListener("input", debounce(async (e) => {
      if (!(currentUser && isAdmin)) return;
      const text = e.target.value;
      try {
        checklistStatus.textContent = "ì €ì¥ ì¤‘â€¦";
        await dashboardRef.set({
          checklist: text,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: currentUser.uid
        }, { merge: true });
        checklistStatus.textContent = "ì €ì¥ë¨";
      } catch (err) {
        console.error("NOTICE save error:", err);
        checklistStatus.textContent = "ì˜¤ë¥˜: ê¶Œí•œ/ë„¤íŠ¸ì›Œí¬ í™•ì¸";
        if (String(err.code) === "permission-denied") {
          alert("ê´€ë¦¬ìë§Œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }
      }
    }, 700));

    /* ========= 6) ë²„íŠ¼ë“¤ ========= */
    document.getElementById("btnNewWeek")?.addEventListener("click", async () => {
      if (!(auth && currentUser && db)) return alert("ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.");
      if (!confirm('ëª¨ë“  ì‚¬ì—…ì§€êµ¬ì˜ "ì§€ë‚œ ì£¼ ì™„ë£Œ" ê°’ì„ ì´ë²ˆ ì£¼ ì™„ë£Œ ê°’ìœ¼ë¡œ ì´ì›”í•©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?')) return;
      try {
        const snap = await db.collection("projects").get();
        const batch = db.batch();
        snap.forEach(doc => {
          const d = doc.data();
          const totalNow = Number(d.total) || 0;
          const compNow = Number(d.completed) || 0;
          const progNow = (typeof d.progress === "number" && Number.isFinite(d.progress))
            ? Number(d.progress)
            : Math.round((totalNow ? (compNow / totalNow * 100) : 0) * 10) / 10;

          batch.update(doc.ref, {
            completed_last_week: compNow,
            total_last_week: totalNow,
            progress_last_week: progNow,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        await batch.commit();
        alert("ìƒˆ ì£¼ ì‹œì‘ ì™„ë£Œ");
      } catch (e) { alert(e.message); }
    });

    document.getElementById("btnAddProject")?.addEventListener("click", async () => {
      if (!(auth && currentUser && db)) return alert("ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.");
      const name = document.getElementById("inName").value.trim();
      const team = document.getElementById("inTeam").value.trim();
      const total = toNum(document.getElementById("inTotal").value);
      const completed = toNum(document.getElementById("inCompleted").value);
      if (!name || !team) return alert("ì‚¬ì—…ì§€êµ¬ëª…ê³¼ íŒ€ì„ ì…ë ¥í•˜ì„¸ìš”.");
      try {
        await db.collection("projects").add({
          name, team, total, completed,
          completed_last_week: completed,
          total_last_week: total,
          progress: pctInt(completed, total),
          progress_last_week: pct1(completed, total),
          lx_note: "", authorityFeedback: "",
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById("inName").value = "";
        document.getElementById("inTeam").value = "";
        document.getElementById("inTotal").value = "";
        document.getElementById("inCompleted").value = "";
      } catch (e) { alert("ì¶”ê°€ ì‹¤íŒ¨: " + (e.message || e)); }
    });

    document.getElementById("btnAddSample")?.addEventListener("click", async () => {
      if (!(auth && currentUser && db)) return alert("ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.");
      const samples = [
        { name: "ì œì£¼-ì„œë¶€1ì§€êµ¬", team: "AíŒ€", total: 140, completed: 90 },
        { name: "ì œì£¼-ì„œë¶€2ì§€êµ¬", team: "AíŒ€", total: 110, completed: 45 },
        { name: "ì œì£¼-ë¶ë¶€ì§€êµ¬", team: "BíŒ€", total: 95, completed: 80 },
        { name: "ì œì£¼-ì¤‘ì‚°ê°„ì§€êµ¬", team: "BíŒ€", total: 200, completed: 60 },
        { name: "ì œì£¼-ì„œê·€í¬ì§€êµ¬", team: "CíŒ€", total: 150, completed: 15 }
      ];
      try {
        const batch = db.batch();
        const col = db.collection("projects");
        samples.forEach(s => {
          const ref = col.doc();
          batch.set(ref, {
            ...s,
            completed_last_week: s.completed,
            total_last_week: s.total,
            lx_note: "",
            authorityFeedback: "",
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        await batch.commit();
        alert("ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€ ì™„ë£Œ");
      } catch (e) { alert("ì¶”ê°€ ì‹¤íŒ¨: " + (e.message || e)); }
    });

    document.getElementById("btnExport")?.addEventListener("click", () => exportCSV(latestProjects));

    document.getElementById("btnRequestEdit")?.addEventListener("click", async () => {
      if (!(auth && currentUser && db)) return alert("ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.");
      const note = prompt("ìš”ì²­ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš” (lx ê¹€í˜•ìœ¤, ë‚¨ì› ã…‡ã…‡ã…‡)");
      try {
        await db.collection("edit_requests").doc(currentUser.uid).set({
          uid: currentUser.uid,
          note: note || "",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("ìš”ì²­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ í›„ í¸ì§‘ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      } catch (e) { alert(e.message); }
    });

    btnDeleteAll?.addEventListener("click", async () => {
      if (!isAdmin) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      if (!confirm("ëª¨ë“  ì‚¬ì—…ì§€êµ¬ ë¬¸ì„œë¥¼ ì‚­ì œí• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)")) return;
      try {
        const snap = await db.collection("projects").get();
        const batch = db.batch();
        snap.forEach(d => batch.delete(d.ref));
        await batch.commit();
        alert("ì „ì²´ ì‚­ì œ ì™„ë£Œ");
      } catch (e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + (e.message || e)); }
    });

    /* ========= 7) CSV ========= */
    function exportCSV(rows) {
      const headers = [
        "team",
        "name",
        "total",
        "completed",
        "completed_last_week",
        "progress_now",
        "progress_prev",
        "delta_pp",
        "lx_note",
        "authorityFeedback"
      ];
      const lines = [headers.join(",")];

      rows.forEach(r => {
        const total = Number(r.total) || 0;
        const comp = Number(r.completed) || 0;

        const last = Number(
          r.completed_last_week ?? r.completed ?? 0
        );
        const lastTotal = Number(
          (r.total_last_week ?? r.total ?? 0)
        );

        const hasNowPct = (typeof r.progress === "number" && Number.isFinite(r.progress));
        const hasPrevPct = (typeof r.progress_last_week === "number" && Number.isFinite(r.progress_last_week));

        const pNow = hasNowPct
          ? Number(r.progress)
          : pctSafe(comp, total);

        let pPrev = hasPrevPct
          ? Number(r.progress_last_week)
          : pctSafe(last, lastTotal);

        if (!Number.isFinite(pPrev)) {
          pPrev = pNow;
        }

        const hasPrevData = Number.isFinite(pPrev);

        const diff = hasPrevData
          ? (Math.round((pNow - pPrev) * 10) / 10)
          : null;

        const vals = [
          r.team || "",
          r.name || "",
          total,
          comp,
          Number.isFinite(last) ? last : "",
          pNow.toFixed(1),
          hasPrevData ? pPrev.toFixed(1) : "",
          hasPrevData
            ? ((diff >= 0 ? "+" : "") + diff.toFixed(1))
            : "â€”",
          quote(r.lx_note || r.lxNotes || ""),
          quote(r.authorityFeedback || "")
        ];
        lines.push(vals.join(","));
      });

      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([bom, lines.join("\r\n")], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "projects.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 0);
    }


    /* ========= 8) ê´€ë¦¬ì íŒ¨ë„ ========= */
    const requestsBox = document.getElementById("requests");
    const editorsBox = document.getElementById("editors");
    let unsubsAdmin = [];
    function clearAdminStreams() { unsubsAdmin.forEach(u => u && u()); unsubsAdmin = []; }
    function bindAdminStreams() {
      clearAdminStreams();
      if (!isAdmin) return;
      unsubsAdmin.push(
        db.collection("edit_requests").orderBy("createdAt", "desc").onSnapshot(snap => {
          if (!requestsBox) return;
          if (snap.empty) {
            requestsBox.innerHTML = '<div class="muted">ëŒ€ê¸° ìš”ì²­ ì—†ìŒ</div>';
            return;
          }
          requestsBox.innerHTML = snap.docs.map(d => {
            const x = d.data();
            return `
              <div class="flex" style="justify-content:space-between;border:1px solid #1b2446;border-radius:10px;padding:10px;margin:6px 0">
                <div>
                  <div><b>UID:</b> ${d.id}</div>
                  <div class="muted">${esc(x.note || "ìš”ì²­ ì‚¬ìœ  ì—†ìŒ")}</div>
                </div>
                <div class="btn-row">
                  <button class="btn accent" onclick="approveEditor('${d.id}')">ìŠ¹ì¸(LX)</button>
                  <button class="btn danger" onclick="rejectRequest('${d.id}')">ê±°ì ˆ</button>
                </div>
              </div>`;
          }).join("");
        })
      );
      unsubsAdmin.push(
        db.collection("roles").orderBy("role").onSnapshot(snap => {
          if (!editorsBox) return;
          if (snap.empty) {
            editorsBox.innerHTML = '<div class="muted">ê¶Œí•œ ì‚¬ìš©ì ì—†ìŒ</div>';
            return;
          }
          editorsBox.innerHTML = snap.docs.map(d => {
            const x = d.data();
            return `
              <div class="flex" style="justify-content:space-between;border:1px solid #1b2446;border-radius:10px;padding:10px;margin:6px 0">
                <div><b>${d.id.slice(0, 10)}...</b> <span class="badge">${esc(x.role)}</span></div>
                <div class="btn-row">
                  ${x.role !== "admin"
                ? `<button class="btn danger" onclick="revokeEditor('${d.id}')">ê¶Œí•œ íšŒìˆ˜</button>`
                : ""}
                </div>
              </div>`;
          }).join("");
        })
      );
    }
    window.approveEditor = async function (targetUid) {
      try {
        await db.collection("roles").doc(targetUid).set(
          { role: "lx", grantedAt: firebase.firestore.FieldValue.serverTimestamp() },
          { merge: true }
        );
        await db.collection("edit_requests").doc(targetUid).delete();
        alert("ìŠ¹ì¸ ì™„ë£Œ (LX ê¶Œí•œ)");
      } catch (e) { alert(e.message); }
    };
    window.rejectRequest = async function (targetUid) {
      try {
        await db.collection("edit_requests").doc(targetUid).delete();
      } catch (e) { alert(e.message); }
    };
    window.revokeEditor = async function (targetUid) {
      if (!confirm("ì´ ì‚¬ìš©ìì˜ ê¶Œí•œì„ íšŒìˆ˜í• ê¹Œìš”? (ë³´ê¸°ë§Œ ê°€ëŠ¥)")) return;
      try {
        await db.collection("roles").doc(targetUid).set(
          { role: "namwon" },
          { merge: true }
        );
        alert("íšŒìˆ˜ ì™„ë£Œ");
      } catch (e) { alert(e.message); }
    };

    /* ========= 9) íŒ€ í•„í„° ========= */
    let lastTeamOptionSig = "";
    function buildTeamFilter(rows) {
      if (!teamFilterEl) return;
      const teams = Array.from(
        new Set(
          rows.map(r => (r.team || "").trim()).filter(Boolean)
        )
      ).sort();
      const sig = teams.join("|");
      if (sig === lastTeamOptionSig) return;
      const current = teamFilterEl.value || "__ALL__";
      teamFilterEl.innerHTML =
        `<option value="__ALL__">ì „ì²´</option>` +
        teams.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join("");
      lastTeamOptionSig = sig;
      const keep = [...teamFilterEl.options].some(o => o.value === current);
      teamFilterEl.value = keep ? current : "__ALL__";
    }
    function applyTeamFilter() {
      if (!teamFilterEl) return;
      const v = teamFilterEl.value;
      document.querySelectorAll("#tbody tr").forEach(tr => {
        const t = (tr.dataset.team || "").trim();
        tr.style.display = (v === "__ALL__" || t === v) ? "" : "none";
      });
    }
    teamFilterEl?.addEventListener("change", applyTeamFilter);

    /* ========= 10) ìœ í‹¸ ========= */
    function debounce(fn, wait) {
      let t;
      return function () {
        clearTimeout(t);
        const args = arguments;
        t = setTimeout(function () {
          fn.apply(null, args);
        }, wait);
      };
    }
  </script>

  <!-- 11) ìº˜ë¦°ë” -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <script>
    /* ===== ìº˜ë¦°ë”(FullCalendar) + Firestore ì—°ë™ ===== */
    let calendar;
    let eventsUnsub = null;
    const CAL_COL = "calendar_events";

    function initCalendar() {
      const calendarEl = document.getElementById("calendar");
      if (!calendarEl) return;

      if (calendar) {
        calendar.setOption("editable", !!(currentUser && (isEditor || isAdmin)));
        calendar.setOption("selectable", !!(currentUser && (isEditor || isAdmin)));
        calendar.setOption("headerToolbar", {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,timeGridDay"
        });
        return;
      }

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        height: 'parent',
        editable: !!(currentUser && (isEditor || isAdmin)),
        selectable: !!(currentUser && (isEditor || isAdmin)),
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,timeGridDay"
        },
        select: async function (info) {
          if (!(currentUser && (isEditor || isAdmin))) { calendar.unselect(); return; }
          const title = prompt("ì¼ì • ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:");
          if (!title) { calendar.unselect(); return; }
          try {
            await db.collection(CAL_COL).add({
              title,
              start: info.start,
              end: info.end,
              allDay: info.allDay,
              createdBy: currentUser.uid,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } catch (e) {
            alert("ì¼ì • ì¶”ê°€ ì‹¤íŒ¨: " + (e.message || e));
          } finally {
            calendar.unselect();
          }
        },
        eventClick: async function (info) {
          if (!(currentUser && (isEditor || isAdmin))) return;
          if (!confirm("ì´ ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?")) return;
          try {
            await db.collection(CAL_COL).doc(info.event.id).delete();
          } catch (e) {
            alert("ì‚­ì œ ì‹¤íŒ¨: " + (e.message || e));
          }
        },
        eventDrop: async function (info) {
          if (!(currentUser && (isEditor || isAdmin))) { info.revert(); return; }
          try {
            await db.collection(CAL_COL).doc(info.event.id).update({
              start: info.event.start,
              end: info.event.end,
              allDay: info.event.allDay,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } catch (e) {
            info.revert();
            alert("ì´ë™ ì‹¤íŒ¨: " + (e.message || e));
          }
        },
        eventResize: async function (info) {
          if (!(currentUser && (isEditor || isAdmin))) { info.revert(); return; }
          try {
            await db.collection(CAL_COL).doc(info.event.id).update({
              start: info.event.start,
              end: info.event.end,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } catch (e) {
            info.revert();
            alert("ìˆ˜ì • ì‹¤íŒ¨: " + (e.message || e));
          }
        }
      });

      calendar.render();
    }

    function bindCalendarStreams() {
      if (eventsUnsub) { eventsUnsub(); eventsUnsub = null; }
      if (!db) return;

      eventsUnsub = db.collection(CAL_COL)
        .orderBy("start", "asc")
        .onSnapshot((snap) => {
          if (!calendar) return;
          snap.docChanges().forEach((chg) => {
            const id = chg.doc.id;
            const d = chg.doc.data();
            const ev = {
              id,
              title: d.title || "(ì œëª© ì—†ìŒ)",
              start: d.start ? new Date(d.start.seconds ? d.start.seconds * 1000 : d.start) : null,
              end: d.end ? new Date(d.end.seconds ? d.end.seconds * 1000 : d.end) : null,
              allDay: !!d.allDay
            };
            if (chg.type === "added") {
              const exist = calendar.getEventById(id);
              if (exist) exist.remove();
              calendar.addEvent(ev);
            } else if (chg.type === "modified") {
              const e = calendar.getEventById(id);
              if (e) {
                e.setProp("title", ev.title);
                e.setDates(ev.start, ev.end, { allDay: ev.allDay });
              } else {
                calendar.addEvent(ev);
              }
            } else if (chg.type === "removed") {
              const e = calendar.getEventById(id);
              e && e.remove();
            }
          });
        }, (err) => {
          console.warn("calendar_events listen error:", err);
        });
    }
  </script>
</body>

</html>