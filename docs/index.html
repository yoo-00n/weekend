<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ì‚¬ì—…ì§€êµ¬ ê³µì •ë¥  ëŒ€ì‹œë³´ë“œ</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Firebase (Compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <style>
    :root { --bg:#0b1020; --card:#111834; --muted:#8fa3c1; --text:#e8eefb; --brand:#5aa0ff; --accent:#46e0b7; --danger:#ef4444; --ring:#233053; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0a0f1e 0%,#0b1226 100%);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(10,15,30,.7);border-bottom:1px solid #1b2446}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .row{display:grid;gap:16px}
    .row.cols-2{grid-template-columns:repeat(2,1fr)}
    .card{background:linear-gradient(180deg,#0f1732 0%,#0e1530 100%);border:1px solid #1b2446;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .card h2{font-size:18px;margin:0 0 8px 0;color:#cfe0ff}
    .card .pad{padding:16px}
    .kpi{display:flex;align-items:baseline;gap:8px}
    .kpi .big{font-size:24px;font-weight:800}
    .kpi .sub{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:1px solid #2a3a70;background:#12204a;color:#eaf2ff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn:hover{background:#16265a}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .danger{background:#2b0e13;border-color:#4a0d17}
    .danger:hover{background:#3a131a}
    .accent{background:#0d2b24;border-color:#0a4034}
    .accent:hover{background:#123c32}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    thead th{font-size:12px;text-transform:uppercase;color:#a9b8d9;text-align:left;padding:0 8px}
    tbody td{background:linear-gradient(180deg,#0f1732 0%,#0e1530 100%);border:1px solid #1b2446;border-left:0;border-right:0;padding:12px 8px}
    tbody tr{border-radius:12px;overflow:hidden}
    tbody td:first-child{border-left:1px solid #1b2446;border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody td:last-child{border-right:1px solid #1b2446;border-top-right-radius:12px;border-bottom-right-radius:12px}

    input[type="number"], input[type="text"], textarea, select{
      width:100%;background:#0a1330;border:1px solid #1f2c57;color:#e8eefb;border-radius:10px;padding:8px;outline:none
    }
    input:focus, textarea:focus{box-shadow:0 0 0 3px var(--ring)}
    textarea{min-height:64px;resize:vertical}

    .delta{font-weight:700}
    .delta.changed{color:var(--danger)}
    .tag{display:inline-flex;align-items:center;gap:6px;border:1px solid #27407d;background:#0c1a3f;padding:6px 10px;border-radius:999px;font-size:12px;color:#cfe0ff}
    .footer{color:#91a1c4;font-size:12px;margin-top:8px}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .hidden{display:none}

    /* ëŒ€ì‹œë³´ë“œ ë ˆì´ì•„ì›ƒ(ì°¨íŠ¸ ì¢Œ / ìš°ì¸¡ 2ì—´) */
    .dash{display:grid;grid-template-columns:380px 1fr;gap:16px}
    @media (max-width: 980px){ .dash{grid-template-columns:1fr} }
    .dash-right{display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:minmax(0,auto);gap:16px}
    .span-2{grid-column:1 / span 2}
    .badge{border:1px solid #2d3d72;background:#0e1b40;padding:4px 8px;border-radius:999px;font-size:12px;color:#cfe0ff}
  </style>
</head>
<body>
  <!--
    ğŸ” Firestore ê·œì¹™(í•„ìˆ˜):
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /{document=**} { allow read: if true; } // ëª¨ë‘ ì½ê¸°
        match /projects/{doc} { allow write: if isEditor(); }
        match /settings/{doc} { allow write: if isEditor(); }
        match /roles/{uid} {
          allow read: if true;
          allow write: if isAdmin(); // ê´€ë¦¬ìë§Œ roles ì¡°ì‘
        }
        match /edit_requests/{uid} {
          allow create: if request.auth != null && request.auth.uid == uid;
          allow read, update, delete: if isAdmin();
        }
        function isEditor() {
          return request.auth != null
            && exists(/databases/$(database)/documents/roles/$(request.auth.uid));
        }
        function isAdmin() {
          return request.auth != null
            && exists(/databases/$(database)/documents/roles/$(request.auth.uid))
            && get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role == "admin";
        }
      }
    }
    âš ï¸ ìµœì´ˆ 1íšŒ: ì½˜ì†”ì—ì„œ ê´€ë¦¬ì UIDë¡œ roles/{adminUid} = {role:"admin"} ë¬¸ì„œë¥¼ ìˆ˜ë™ ìƒì„±
  -->

  <header>
    <div class="wrap flex" style="padding:12px 20px">
      <div class="flex" style="gap:10px">
        <span class="tag">ì‚¬ì—…ì§€êµ¬ ê³µì •ë¥  ëŒ€ì‹œë³´ë“œ</span>
        <span class="muted">ì‹¤ì‹œê°„ ë™ê¸°í™” (Firebase Â· ìµëª… ë¡œê·¸ì¸)</span>
      </div>
      <div class="spacer"></div>
      <div class="flex">
        <span id="userInfo" class="muted">ì ‘ì† í•„ìš”</span>
        <span id="roleBadge" class="badge hidden"></span>
        <button id="btnSignIn" class="btn">ìµëª…ìœ¼ë¡œ ì‹œì‘</button>
        <button id="btnSignOut" class="btn hidden">ì¢…ë£Œ</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:16px">
    <!-- DASHBOARD -->
    <div class="dash">
      <!-- LEFT: Donut -->
      <div class="card"><div class="pad">
        <h2>ì „ì²´ ê³µì •ë¥ </h2>
        <div class="kpi"><span id="kpiProgress" class="big">0%</span><span class="sub" id="kpiParcels">0 / 0 í•„ì§€</span></div>
        <canvas id="overallDonut" style="margin-top:6px;height:120px"></canvas>
      </div></div>

      <!-- RIGHT: Top/Bottom + í™•ì¸ì‚¬í•­ -->
      <div class="dash-right">
        <div class="card"><div class="pad">
          <h2>Top 3 ì‚¬ì—…ì§€êµ¬</h2>
          <ol id="top3" class="muted" style="padding-left:18px;margin:0"></ol>
          <div class="footer">ì§„í–‰ë¥ (%) ê¸°ì¤€</div>
        </div></div>
        <div class="card"><div class="pad">
          <h2>Bottom 3 ì‚¬ì—…ì§€êµ¬</h2>
          <ol id="bottom3" class="muted" style="padding-left:18px;margin:0"></ol>
          <div class="footer">ì§„í–‰ë¥ (%) ê¸°ì¤€</div>
        </div></div>
        <div class="card span-2"><div class="pad">
          <h2>í™•ì¸ì‚¬í•­</h2>
          <textarea id="checklist" placeholder="ì˜ˆ: ìë£Œ ë³´ì™„ ëŒ€ìƒ ì§€êµ¬, ì¼ì • ë¦¬ìŠ¤í¬, ëŒ€ë¯¼ ì•ˆë‚´ í•„ìš”ì‚¬í•­ ë“±"></textarea>
          <div class="footer">â€» ì—ë””í„°/ê´€ë¦¬ìë§Œ í¸ì§‘ ê°€ëŠ¥ Â· ì‹¤ì‹œê°„ ê³µìœ </div>
        </div></div>
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="card" style="margin-top:16px"><div class="pad">
      <h2>ê´€ë¦¬ ë„êµ¬</h2>
      <div class="btn-row" style="margin-bottom:10px">
        <button id="btnNewWeek" class="btn">ìƒˆ ì£¼ ì‹œì‘(ì§€ë‚œ ì£¼ ì´ì›”)</button>
        <button id="btnAddSample" class="btn accent">ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€</button>
        <button id="btnExport" class="btn">CSV ë‚´ë³´ë‚´ê¸°</button>
        <button id="btnRequestEdit" class="btn">í¸ì§‘ ê¶Œí•œ ìš”ì²­</button>
      </div>
      <div class="row cols-2">
        <div>
          <h3 style="margin:0 0 8px 0;color:#cfe0ff;font-size:14px">ì‚¬ì—…ì§€êµ¬ ì¶”ê°€</h3>
          <div class="row cols-2">
            <input id="inName" type="text" placeholder="ì‚¬ì—…ì§€êµ¬ëª…" />
            <input id="inTeam" type="text" placeholder="ë‹´ë‹¹íŒ€" />
          </div>
          <div class="row cols-2" style="margin-top:8px">
            <input id="inTotal" type="number" placeholder="ì´ í•„ì§€" />
            <input id="inCompleted" type="number" placeholder="ì™„ë£Œ(ì´ë²ˆ ì£¼)" />
          </div>
          <div class="btn-row" style="margin-top:8px">
            <button id="btnAddProject" class="btn">ì¶”ê°€</button>
          </div>
          <div class="footer">â€» í¸ì§‘ ê¶Œí•œ(roles)ì— ë”°ë¼ ì…ë ¥ ê°€ëŠ¥. Î”ëŠ” ì§€ë‚œ ì£¼ ëŒ€ë¹„ ë³€í™”(pp).</div>
        </div>
        <div>
          <h3 style="margin:0 0 8px 0;color:#cfe0ff;font-size:14px">ì„¤ëª…</h3>
          <ul class="muted" style="margin:0 0 6px 16px;padding:0">
            <li>ì¢Œ: ì „ì²´ ê³µì •ë¥  ë„ë„›(ë†’ì´ ì ˆë°˜)</li>
            <li>ìš°: Top/Bottom3 + í™•ì¸ì‚¬í•­(ì‹¤ì‹œê°„)</li>
            <li>í‘œ: íŒ€ë³„ í˜„í™©, Î”(pp), LX/ì†Œê´€ì²­ ë©”ëª¨</li>
          </ul>
        </div>
      </div>
    </div></div>

    <!-- TABLE -->
    <div class="card" style="margin-top:16px"><div class="pad">
      <h2>ë‹´ë‹¹íŒ€ë³„ ì‚¬ì—…ì§€êµ¬ í˜„í™©</h2>
      <table>
        <thead>
          <tr>
            <th>ë‹´ë‹¹íŒ€</th>
            <th>ì‚¬ì—…ì§€êµ¬</th>
            <th>ì´ í•„ì§€</th>
            <th>ì™„ë£Œ (ì´ë²ˆ ì£¼)</th>
            <th>ê³µì •ë¥  (%)</th>
            <th>Î” ì£¼ê°„ (pp)</th>
            <th>LX ì¸ìˆ˜ì¸ê³„</th>
            <th>ì†Œê´€ì²­ í”¼ë“œë°±</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div></div>

    <!-- ADMIN PANEL (ê´€ë¦¬ì ì „ìš©) -->
    <div id="adminPanel" class="card hidden" style="margin-top:16px"><div class="pad">
      <h2>ê´€ë¦¬ì íŒ¨ë„ Â· ê¶Œí•œ ìŠ¹ì¸</h2>
      <div class="footer">ì—¬ê¸° ë³´ì´ëŠ” í•­ëª©ì€ <b>role=admin</b> ì‚¬ìš©ìì—ê²Œë§Œ í‘œì‹œë©ë‹ˆë‹¤.</div>
      <h3 style="color:#cfe0ff;margin-top:12px">ìŠ¹ì¸ ëŒ€ê¸° ìš”ì²­</h3>
      <div id="requests"></div>
      <h3 style="color:#cfe0ff;margin-top:12px">í˜„ì¬ ì—ë””í„°</h3>
      <div id="editors"></div>
    </div></div>

  </main>

  <script>
  // =========================
  // 1) Firebase ì„¤ì • (ì•„ë˜ë¥¼ ë³¸ì¸ í”„ë¡œì íŠ¸ ì •ë³´ë¡œ êµì²´)
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyBDQSpN1_hV5cj9wDHqzxwIEfWHUsuMEu0",
    authDomain: "weekend-6d16d.firebaseapp.com",
    projectId: "weekend-6d16d",
    storageBucket: "weekend-6d16d.firebasestorage.app",
    messagingSenderId: "399772383646",
    appId: "1:399772383646:web:21208b83404479669c3e8f",
    measurementId: "G-35FK2FRMBZ"
  };

  function looksUnconfigured(cfg){
    return Object.values(cfg).some(v => typeof v === 'string' && v.startsWith('YOUR_'));
  }

  let app, db, auth;
  let donutChart = null;
  let currentUser = null;
  let isEditor = false;
  let isAdmin = false;

  try {
    if(looksUnconfigured(firebaseConfig)){
      throw new Error('Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. index.html ìƒë‹¨ì˜ firebaseConfigë¥¼ êµì²´í•˜ì„¸ìš”.');
    }
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
  } catch(err){
    console.error(err);
    document.getElementById('userInfo').textContent = 'Firebase ë¯¸ì„¤ì • (ë³´ê¸° ì „ìš©)';
    document.getElementById('btnSignIn').disabled = true;
    document.getElementById('btnSignOut').disabled = true;
  }

  // =========================
  // 2) ì¸ì¦ (ìµëª… ë¡œê·¸ì¸)
  // =========================
  const btnSignIn = document.getElementById('btnSignIn');
  const btnSignOut = document.getElementById('btnSignOut');
  const userInfo = document.getElementById('userInfo');
  const roleBadge = document.getElementById('roleBadge');
  const adminPanel = document.getElementById('adminPanel');

  if(auth){
    auth.onAuthStateChanged(async user => {
      currentUser = user;
      if(user){
        userInfo.textContent = `ì†ë‹˜(${user.uid.slice(0,6)}) ì ‘ì†`;
        btnSignIn.classList.add('hidden');
        btnSignOut.classList.remove('hidden');

        await refreshRole();
        setControlsEnabled(true);
      } else {
        userInfo.textContent = 'ì ‘ì† í•„ìš”';
        btnSignIn.classList.remove('hidden');
        btnSignOut.classList.add('hidden');
        roleBadge.classList.add('hidden');
        isEditor = false; isAdmin = false;
        setControlsEnabled(false);
      }
    });

    btnSignIn.addEventListener('click', async () => {
      try { await auth.signInAnonymously(); }
      catch(e){ alert(`[ë¡œê·¸ì¸ ì‹¤íŒ¨] ${e.code||''} ${e.message||e}`); }
    });
    btnSignOut.addEventListener('click', async () => { await auth.signOut(); });
  }

  async function refreshRole(){
    if(!(db && currentUser)) return;
    const r = await db.collection('roles').doc(currentUser.uid).get();
    if(r.exists){
      const role = (r.data().role || 'editor').toLowerCase();
      isEditor = true;
      isAdmin = role === 'admin';
      roleBadge.textContent = isAdmin ? 'admin' : 'editor';
      roleBadge.classList.remove('hidden');
      if(isAdmin){ adminPanel.classList.remove('hidden'); bindAdminStreams(); }
      else { adminPanel.classList.add('hidden'); }
    } else {
      isEditor = false; isAdmin = false;
      roleBadge.textContent = 'view';
      roleBadge.classList.remove('hidden');
      adminPanel.classList.add('hidden');
    }
  }

  function setControlsEnabled(enabled){
    const ids = ['btnNewWeek','btnAddProject','btnAddSample'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if(!el) return;
      // ë²„íŠ¼ ìì²´ëŠ” ë¡œê·¸ì¸ ì‹œ í™œì„±í™”í•˜ë˜, ì‹¤ì œ ì“°ê¸° ê¶Œí•œì€ ê·œì¹™ì—ì„œ ê²°ì •
      el.disabled = !(enabled);
    });
    document.getElementById('checklist').disabled = !(enabled && isEditor);
    renderProjects(latestProjects);
  }

  // =========================
  // 3) ë°ì´í„° êµ¬ë…
  // =========================
  const tbody = document.getElementById('tbody');
  const top3El = document.getElementById('top3');
  const bottom3El = document.getElementById('bottom3');
  const kpiProgressEl = document.getElementById('kpiProgress');
  const kpiParcelsEl = document.getElementById('kpiParcels');
  const checklistEl = document.getElementById('checklist');

  let latestProjects = [];

  if(db){
    db.collection('projects').orderBy('team').orderBy('name').onSnapshot(snap => {
      latestProjects = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      renderProjects(latestProjects); renderDashboard(latestProjects);
    });
    db.collection('settings').doc('dashboard').onSnapshot(doc => {
      const d = doc.data() || {};
      checklistEl.value = d.checklist || '';
    });
  }

  checklistEl.addEventListener('input', debounce(async ()=>{
    if(!(auth && currentUser && db)) return;
    try{
      await db.collection('settings').doc('dashboard').set({
        checklist: checklistEl.value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
    }catch(e){
      if(e.code === 'permission-denied') alert('í¸ì§‘ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”)');
      else console.error(e);
    }
  }, 600));

  function pct(completed,total){
    const p = (!total||total<=0) ? 0 : (completed/total*100);
    return Math.round(p*10)/10;
  }

  function renderDashboard(rows){
    const totalAll = rows.reduce((s,r)=>s+(Number(r.total)||0),0);
    const doneAll  = rows.reduce((s,r)=>s+(Number(r.completed)||0),0);
    const progress = pct(doneAll,totalAll);
    kpiProgressEl.textContent = progress.toFixed(1)+'%';
    kpiParcelsEl.textContent = `${doneAll} / ${totalAll} í•„ì§€`;

    const remain = Math.max(0,totalAll-doneAll);
    const data = { labels:['ì™„ë£Œ','ì”ì—¬'], datasets:[{ data:[doneAll, remain] }] };
    const opt = { plugins:{ legend:{ labels:{ color:'#cfe0ff' } } }, cutout:'60%' };
    const ctx = document.getElementById('overallDonut');
    if(donutChart){ donutChart.data = data; donutChart.update(); }
    else { donutChart = new Chart(ctx,{ type:'doughnut', data, options:opt }); }

    const withPct = rows.map(r=> ({...r, p:pct(Number(r.completed)||0, Number(r.total)||0)}))
                        .filter(r=> (Number(r.total)||0) > 0)
                        .sort((a,b)=>b.p - a.p);
    const top = withPct.slice(0,3);
    const bottom = withPct.slice(-3).reverse();
    top3El.innerHTML = top.map(r=>`<li>${r.name} <span class="muted">(${r.p.toFixed(1)}%)</span></li>`).join('');
    bottom3El.innerHTML = bottom.map(r=>`<li>${r.name} <span class="muted">(${r.p.toFixed(1)}%)</span></li>`).join('');
  }

  function renderProjects(rows){
    tbody.innerHTML = '';
    rows.forEach(r => {
      const total = Number(r.total)||0;
      const comp  = Number(r.completed)||0;
      const last  = Number(r.completed_last_week)||0;
      const pNow  = pct(comp,total);
      const pPrev = pct(last,total);
      const diff  = Math.round((pNow-pPrev)*10)/10;
      const changed = Math.abs(diff) > 0.0001;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(r.team||'')}</td>
        <td>${esc(r.name||'')}</td>
        <td><input type="number" class="in-total" data-id="${r.id}" value="${total}" ${inputEditable()} /></td>
        <td><input type="number" class="in-completed" data-id="${r.id}" value="${comp}" ${inputEditable()} /></td>
        <td>${pNow.toFixed(1)}%</td>
        <td class="delta ${changed?'changed':''}">${changed? (diff>0?'+':'')+diff.toFixed(1):'â€”'}</td>
        <td><textarea class="in-lx" data-id="${r.id}" ${inputEditable()}>${esc(r.lxNotes||'')}</textarea></td>
        <td><textarea class="in-auth" data-id="${r.id}" ${inputEditable()}>${esc(r.authorityFeedback||'')}</textarea></td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('.in-total').forEach(el=>{
      el.addEventListener('input', debounce(e=> saveField(e.target,'total', toNum(e.target.value)), 500));
    });
    tbody.querySelectorAll('.in-completed').forEach(el=>{
      el.addEventListener('input', debounce(e=> saveField(e.target,'completed', toNum(e.target.value)), 500));
    });
    tbody.querySelectorAll('.in-lx').forEach(el=>{
      el.addEventListener('input', debounce(e=> saveField(e.target,'lxNotes', e.target.value), 700));
    });
    tbody.querySelectorAll('.in-auth').forEach(el=>{
      el.addEventListener('input', debounce(e=> saveField(e.target,'authorityFeedback', e.target.value), 700));
    });
  }

  function inputEditable(){ return (auth && currentUser && isEditor) ? '' : 'disabled'; }
  function toNum(v){ const n = Number(v); return isFinite(n)? n: 0; }
  function esc(s){ return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  async function saveField(el, field, value){
    if(!(auth && currentUser && db)) return;
    const id = el.getAttribute('data-id');
    try{
      await db.collection('projects').doc(id).update({ [field]: value, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    }catch(e){
      if(e.code === 'permission-denied') alert('í¸ì§‘ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”)');
      else alert('ì €ì¥ ì‹¤íŒ¨: '+ e.message);
    }
  }

  // =========================
  // 4) ë²„íŠ¼ë“¤: ìƒˆ ì£¼ / ì¶”ê°€ / ìƒ˜í”Œ / CSV / ê¶Œí•œìš”ì²­
  // =========================
  document.getElementById('btnNewWeek').addEventListener('click', async () => {
    if(!(auth && currentUser && db)) return alert('ë¨¼ì € ì‹œì‘í•˜ì„¸ìš”.');
    if(!confirm('ëª¨ë“  ì‚¬ì—…ì§€êµ¬ì˜ "ì§€ë‚œ ì£¼ ì™„ë£Œ" ê°’ì„ ì´ë²ˆ ì£¼ ì™„ë£Œ ê°’ìœ¼ë¡œ ì´ì›”í•©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?')) return;
    const snap = await db.collection('projects').get();
    const batch = db.batch();
    snap.forEach(doc => {
      const d = doc.data();
      batch.update(doc.ref, { completed_last_week: Number(d.completed)||0, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    });
    try{ await batch.commit(); alert('ìƒˆ ì£¼ ì‹œì‘ ì™„ë£Œ'); }
    catch(e){ alert(e.message); }
  });

  document.getElementById('btnAddProject').addEventListener('click', async () => {
    if(!(auth && currentUser && db)) return alert('ë¨¼ì € ì‹œì‘í•˜ì„¸ìš”.');
    const name = document.getElementById('inName').value.trim();
    const team = document.getElementById('inTeam').value.trim();
    const total = toNum(document.getElementById('inTotal').value);
    const completed = toNum(document.getElementById('inCompleted').value);
    if(!name || !team) return alert('ì‚¬ì—…ì§€êµ¬ëª…ê³¼ íŒ€ì„ ì…ë ¥í•˜ì„¸ìš”.');
    try{
      await db.collection('projects').add({
        name, team, total, completed, completed_last_week: completed,
        lxNotes:'', authorityFeedback:'',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById('inName').value='';
      document.getElementById('inTeam').value='';
      document.getElementById('inTotal').value='';
      document.getElementById('inCompleted').value='';
    }catch(e){ alert('ì¶”ê°€ ì‹¤íŒ¨: '+e.message); }
  });

  document.getElementById('btnAddSample').addEventListener('click', async () => {
    if(!(auth && currentUser && db)) return alert('ë¨¼ì € ì‹œì‘í•˜ì„¸ìš”.');
    const samples = [
      {name:'ì œì£¼-ì„œë¶€1ì§€êµ¬', team:'AíŒ€', total:140, completed:90},
      {name:'ì œì£¼-ì„œë¶€2ì§€êµ¬', team:'AíŒ€', total:110, completed:45},
      {name:'ì œì£¼-ë¶ë¶€ì§€êµ¬',  team:'BíŒ€', total:95,  completed:80},
      {name:'ì œì£¼-ì¤‘ì‚°ê°„ì§€êµ¬',team:'BíŒ€', total:200, completed:60},
      {name:'ì œì£¼-ì„œê·€í¬ì§€êµ¬',team:'CíŒ€', total:150, completed:15},
    ];
    const batch = db.batch();
    const col = db.collection('projects');
    samples.forEach(s => {
      const ref = col.doc();
      batch.set(ref, { ...s, completed_last_week: s.completed, lxNotes:'', authorityFeedback:'', updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    });
    try{ await batch.commit(); alert('ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€ ì™„ë£Œ'); }
    catch(e){ alert(e.message); }
  });

  document.getElementById('btnExport').addEventListener('click', () => {
    exportCSV(latestProjects);
  });

  document.getElementById('btnRequestEdit').addEventListener('click', async () => {
    if(!(auth && currentUser && db)) return alert('ë¨¼ì € ì‹œì‘í•˜ì„¸ìš”.');
    const note = prompt('ìš”ì²­ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš” (íŒ€/ì—…ë¬´ ë“±)');
    try{
      await db.collection('edit_requests').doc(currentUser.uid).set({
        uid: currentUser.uid, note: note||'', createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('ìš”ì²­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ í›„ í¸ì§‘ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    }catch(e){ alert(e.message); }
  });

  function exportCSV(rows){
    const headers = ['team','name','total','completed','completed_last_week','progress_now','progress_prev','delta_pp','lxNotes','authorityFeedback'];
    const lines = [headers.join(',')];
    rows.forEach(r => {
      const total = Number(r.total)||0, comp=Number(r.completed)||0, last=Number(r.completed_last_week)||0;
      const pNow=pct(comp,total), pPrev=pct(last,total), d=(pNow-pPrev).toFixed(1);
      const vals = [r.team||'', r.name||'', total, comp, last, pNow.toFixed(1), pPrev.toFixed(1), d, quote(r.lxNotes||''), quote(r.authorityFeedback||'')];
      lines.push(vals.join(','));
    });
    const bom = new Uint8Array([0xEF,0xBB,0xBF]);
    const blob = new Blob([bom, lines.join('\r\n')], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='projects.csv'; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),0);
  }
  function quote(s){ const t = String(s).replaceAll('"','""'); return `"${t}"`; }

  // =========================
  // 5) ê´€ë¦¬ì íŒ¨ë„ (ìŠ¹ì¸/íšŒìˆ˜)
  // =========================
  const requestsBox = document.getElementById('requests');
  const editorsBox  = document.getElementById('editors');
  let unsubsAdmin = [];

  function clearAdminStreams(){ unsubsAdmin.forEach(u=>u&&u()); unsubsAdmin=[]; }

  function bindAdminStreams(){
    clearAdminStreams();
    if(!isAdmin) return;

    // ìŠ¹ì¸ ëŒ€ê¸°
    unsubsAdmin.push(
      db.collection('edit_requests').orderBy('createdAt','desc').onSnapshot(snap=>{
        if(snap.empty){ requestsBox.innerHTML = '<div class="muted">ëŒ€ê¸° ìš”ì²­ ì—†ìŒ</div>'; return; }
        requestsBox.innerHTML = snap.docs.map(d=>{
          const x=d.data();
          return `<div class="flex" style="justify-content:space-between;border:1px solid #1b2446;border-radius:10px;padding:10px;margin:6px 0">
                    <div>
                      <div><b>UID:</b> ${d.id}</div>
                      <div class="muted">${esc(x.note||'ìš”ì²­ ì‚¬ìœ  ì—†ìŒ')}</div>
                    </div>
                    <div class="btn-row">
                      <button class="btn accent" onclick="approveEditor('${d.id}')">ìŠ¹ì¸</button>
                      <button class="btn danger" onclick="rejectRequest('${d.id}')">ê±°ì ˆ</button>
                    </div>
                  </div>`;
        }).join('');
      })
    );

    // í˜„ì¬ ì—ë””í„° ëª©ë¡
    unsubsAdmin.push(
      db.collection('roles').orderBy('role').onSnapshot(snap=>{
        if(snap.empty){ editorsBox.innerHTML = '<div class="muted">ê¶Œí•œ ì‚¬ìš©ì ì—†ìŒ</div>'; return; }
        editorsBox.innerHTML = snap.docs.map(d=>{
          const x=d.data();
          const badge = (x.role==='admin')? 'admin' : 'editor';
          return `<div class="flex" style="justify-content:space-between;border:1px solid #1b2446;border-radius:10px;padding:10px;margin:6px 0">
                    <div><b>${d.id.slice(0,10)}...</b> <span class="badge">${badge}</span></div>
                    <div class="btn-row">
                      ${x.role!=='admin' ? `<button class="btn danger" onclick="revokeEditor('${d.id}')">íšŒìˆ˜</button>`:''}
                    </div>
                  </div>`;
        }).join('');
      })
    );
  }

  // ì „ì—­ì—ì„œ í˜¸ì¶œë˜ë„ë¡ windowì— ë°”ì¸ë”©
  window.approveEditor = async function(targetUid){
    try{
      await db.collection('roles').doc(targetUid).set({ role:'editor', grantedAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
      await db.collection('edit_requests').doc(targetUid).delete();
      alert('ìŠ¹ì¸ ì™„ë£Œ');
    }catch(e){ alert(e.message); }
  }
  window.rejectRequest = async function(targetUid){
    try{ await db.collection('edit_requests').doc(targetUid).delete(); }
    catch(e){ alert(e.message); }
  }
  window.revokeEditor = async function(targetUid){
    if(!confirm('ì´ ì‚¬ìš©ìì˜ í¸ì§‘ ê¶Œí•œì„ íšŒìˆ˜í• ê¹Œìš”?')) return;
    try{ await db.collection('roles').doc(targetUid).delete(); alert('íšŒìˆ˜ ì™„ë£Œ'); }
    catch(e){ alert(e.message); }
  }

  // =========================
  // 6) ìœ í‹¸
  // =========================
  function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }

  </script>
</body>
</html>
