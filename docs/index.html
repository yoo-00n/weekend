<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>남원시 지적재조사 공정 beta</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header>
    <div class="wrap flex" style="padding:12px 20px">
      <div class="flex" style="gap:10px">
        <span class="tag">사업지구 공정률 대시보드</span>
      </div>
      <div class="spacer"></div>
      <div class="flex">
        <span id="userInfo" class="muted">로그인 필요</span>
        <span id="roleBadge" class="badge hidden"></span>
        <button id="btnSignIn" class="btn">로그인</button>
        <button id="btnSignOut" class="btn hidden">로그아웃</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:16px">
    <div class="dash">
      <div class="card">
        <div class="pad">
          <h2>전체 공정률</h2>
          <div class="kpi"><span id="kpiProgress" class="big">0%</span><span class="sub" id="kpiParcels">0 / 0 필지</span>
          </div>
          <canvas id="overallDonut" style="margin-top:6px"></canvas>
        </div>
      </div>

      <div class="dash-right">
        <div class="card">
          <div class="pad">
            <h2>Top 3</h2>
            <ol id="top3" class="muted" style="padding-left:18px;margin:0"></ol>
            <div class="footer">진행률(%) 기준</div>
          </div>
        </div>
        <div class="card">
          <div class="pad">
            <h2>Bottom 3</h2>
            <ol id="bottom3" class="muted" style="padding-left:18px;margin:0"></ol>
            <div class="footer">진행률(%) 기준</div>
          </div>
        </div>
        <div class="card span-2">
          <div class="pad">
            <h2>NOTICE</h2>
            <textarea id="checklist" placeholder="예: 자료 보완 대상 지구, 일정 등" disabled></textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="pad">
        <h2>관리 도구</h2>

        <div class="tools-layout">
          <section>
            <div class="btn-row" style="margin-bottom:10px">
              <button id="btnNewWeek" class="btn" disabled>새 주 시작(지난 주 이월)</button>
              <button id="btnAddSample" class="btn accent" disabled>샘플 데이터 추가</button>
              <button id="btnExport" class="btn">CSV 내보내기</button>
              <button id="btnRequestEdit" class="btn">편집 권한 요청</button>
              <button id="btnDeleteAll" class="btn danger hidden">전체 삭제(관리자)</button>
            </div>

            <div class="row cols-2">
              <div>
                <h3 style="margin:0 0 8px 0;color:#cfe0ff;font-size:14px">사업지구 추가</h3>
                <div class="row cols-2">
                  <input id="inName" type="text" placeholder="사업지구명" />
                  <input id="inTeam" type="text" placeholder="담당팀" />
                </div>
                <div class="row cols-2" style="margin-top:8px">
                  <input id="inTotal" type="number" placeholder="총 필지" />
                  <input id="inCompleted" type="number" placeholder="완료(이번 주)" />
                </div>
                <div class="btn-row" style="margin-top:8px">
                  <button id="btnAddProject" class="btn" disabled>추가</button>
                </div>
                <div class="footer">※ ADMIN만 추가/삭제 가능. Δ는 지난 주 대비 변화(pp).</div>
                <div class="footer">※ lx - 공정률, 일정 편집 가능</div>
                <div class="footer">※ namwon - 일정 편집 가능</div>
              </div>

              <div>
                <h3 style="margin:0 0 8px 0;color:#cfe0ff;font-size:14px">남원시청</h3>
                <ul class="muted" style="margin:0 0 6px 16px;padding:0">
                  <li>1팀 : 김용수, 김두리</li>
                  <li>2팀 : 이대연, 이승원</li>
                  <li>3팀 : 김국환, 노시준</li>
                </ul>
                <h3 style="margin:0 0 8px 0;color:#cfe0ff;font-size:14px">LX</h3>
                <ul class="muted" style="margin:0 0 6px 16px;padding:0">
                  <li>나정환 : 사석/도랑/사매2/송내/강석</li>
                  <li>이근행 : 호곡/평촌/옥전</li>
                  <li>김형윤 : 부절/서곡</li>
                  <li>박광훈 : 호경/내기</li>
                </ul>
              </div>
            </div>
          </section>

          <aside class="calendar-box">
            <div id="calendar"></div>
          </aside>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="pad">
        <h2>담당팀별 사업지구 현황</h2>
        <table>
          <thead>
            <tr>
              <th class="col-team">
                담당팀
                <select id="teamFilter" style="margin-left:.5rem;max-width:120px">
                  <option value="__ALL__">전체</option>
                </select>
              </th>
              <th class="col-name">사업지구</th>
              <th class="col-total">총 필지</th>
              <th class="col-done">완료 (이번 주)</th>
              <th class="col-progress">공정률 (%)</th>
              <th class="col-delta">Δ 주간 (pp)</th>
              <th class="col-handover">LX 전달사항</th>
              <th class="col-feedback">소관청 피드백</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="adminPanel" class="card hidden" style="margin-top:16px">
      <div class="pad">
        <h2>관리자 패널 · 권한 승인</h2>
        <div class="footer">여기 보이는 항목은 <b>role=admin</b> 사용자에게만 표시됩니다.</div>
        <h3 style="color:#cfe0ff;margin-top:12px">승인 대기 요청</h3>
        <div id="requests"></div>
        <h3 style="color:#cfe0ff;margin-top:12px">현재 권한 사용자</h3>
        <div id="editors"></div>
      </div>
    </div>
  </main>

  <!-- 도넛 차트 옆 배너 -->
  <a href="https://yoo-00n.github.io/JAJOSA/" target="_blank" class="floating-banner">
    <img src="https://raw.githubusercontent.com/yoo-00n/weekend/main/docs/banner.png" alt="경계협의서 Beta">
    <div class="banner-icon">📝경계협의서 Beta</div>
  </a>

  <style>
    /* 배너 스타일 */
    .floating-banner {
      position: fixed;
      top: 180px;
      /* 도넛 차트 상단 맞춤 */
      left: 40px;
      /* 도넛 왼쪽 여백 안쪽 */
      z-index: 1000;
      /* 항상 위에 보이게 */
      text-align: center;
      cursor: pointer;
      text-decoration: none;
    }

    .floating-banner img {
      width: 250px;
      height: 170px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s ease;
    }

    .floating-banner img:hover {
      transform: scale(1.08);
    }

    .floating-banner .banner-text {
      margin-top: 6px;
      font-size: 14px;
      font-weight: 600;
      color: #e8eefb;
      /* 대시보드 색상과 통일 */
    }
  </style>


  <script>
    /* ========= 1) Firebase 설정 ========= */
    const firebaseConfig = {
      apiKey: "AIzaSyBDQSpN1_hV5cj9wDHqzxwIEfWHUsuMEu0",
      authDomain: "weekend-6d16d.firebaseapp.com",
      projectId: "weekend-6d16d",
      storageBucket: "weekend-6d16d.appspot.com",
      messagingSenderId: "399772383646",
      appId: "1:399772383646:web:21208b83404479669c3e8f",
      measurementId: "G-35FK2FRMBZ"
    };
    const USER_DOMAIN = "acct.lx.local";

    /* ========= 2) 초기화 ========= */
    const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // KPI 문서 ref (게이지용)
    const projIdForKPI = 'global'; // 전사 합계 KPI 저장 위치
    const statsRef = db.doc(`projects/${projIdForKPI}/stats/kpis`);

    let donutChart = null;
    let currentUser = null;
    let role = null;         // "admin" | "lx" | "namwon" | null
    let isEditor = false;    // (role === "admin" || role === "lx")
    let isAdmin = false;

    /* ========= 3) 인증 ========= */
    const btnSignIn = document.getElementById("btnSignIn");
    const btnSignOut = document.getElementById("btnSignOut");
    const userInfo = document.getElementById("userInfo");
    const roleBadge = document.getElementById("roleBadge");
    const adminPanel = document.getElementById("adminPanel");
    const btnDeleteAll = document.getElementById("btnDeleteAll");

    let unsubs = [];
    function clearDataStreams() { unsubs.forEach(u => u && u()); unsubs = []; }

    function bindDataStreams() {
      clearDataStreams();
      if (!db || !currentUser) return;

      // 1) projects 실시간 → 표/Top3/Bottom3 렌더 + KPI 합계 반영
      unsubs.push(
        db.collection("projects").orderBy("team").onSnapshot((snap) => {
          latestProjects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          latestProjects.sort((a, b) =>
            String(a.team || "").localeCompare(String(b.team || "")) ||
            String(a.name || "").localeCompare(String(b.name || ""))
          );
          renderProjects(latestProjects);
          renderDashboardFromRows(latestProjects);   // 화면 즉시 갱신
          recomputeAndPushStats(latestProjects).catch(console.warn); // KPI 문서 갱신
          buildTeamFilter(latestProjects);
          applyTeamFilter();
        }, (err) => {
          console.warn("projects listen error:", err.code || err.message);
        })
      );

      // 2) KPI(stats/kpis) 실시간 → 도넛/라벨 최종 반영
      unsubs.push(
        statsRef.onSnapshot((snap) => {
          if (!snap.exists) {
            statsRef.set({ total: 0, done: 0, weekComplete: 0 }, { merge: true });
            return;
          }
          const s = snap.data() || {};
          updateGauge(Number(s.done) || 0, Number(s.total) || 0, Number(s.weekComplete) || 0);
        }, (err) => console.warn("stats listen error:", err.code || err.message))
      );

      // 3) settings
      unsubs.push(
        db.collection("settings").doc("dashboard").onSnapshot(doc => {
          const d = doc.data() || {};
          if (checklistEl) checklistEl.value = d.checklist || "";
        }, (err) => { console.warn("settings listen error:", err.code || err.message); })
      );
    }

    if (auth) {
      auth.onAuthStateChanged(async (user) => {
        currentUser = user;
        if (user) {
          const idLike = user.email ? user.email.split("@")[0] : user.uid.slice(0, 6);
          userInfo.textContent = `${idLike} 접속`;
          btnSignIn.classList.add("hidden");
          btnSignOut.classList.remove("hidden");

          await refreshRole();
          setControlsEnabled();
          bindDataStreams();
          initCalendar();
          bindCalendarStreams();
        } else {
          userInfo.textContent = "로그인 필요";
          btnSignIn.classList.remove("hidden");
          btnSignOut.classList.add("hidden");
          roleBadge.classList.add("hidden");
          role = null; isEditor = false; isAdmin = false;
          setControlsEnabled();
          clearDataStreams();
          latestProjects = []; renderProjects(latestProjects); renderDashboardFromRows(latestProjects);
          initCalendar();
          bindCalendarStreams();
        }
      });

      btnSignIn.addEventListener("click", async () => {
        try {
          const username = prompt("아이디를 입력하세요 (예: ADMIN, LX, NAMWON)");
          if (!username) return;
          const password = prompt("비밀번호를 입력하세요");
          if (!password) return;
          const email = `${username.trim()}@${USER_DOMAIN}`;
          await auth.signInWithEmailAndPassword(email, password);
        } catch (e) { alert(`[로그인 실패] ${e.code || ""} ${e.message || e}`); }
      });
      btnSignOut.addEventListener("click", async () => { await auth.signOut(); });
    }

    async function refreshRole() {
      role = null; isEditor = false; isAdmin = false;
      if (!(db && currentUser)) return;
      const r = await db.collection("roles").doc(currentUser.uid).get();
      if (r.exists) {
        role = String(r.data().role || "").toLowerCase();
        isAdmin = role === "admin";
        isEditor = role === "admin" || role === "lx";
        roleBadge.textContent = role || "unknown";
        roleBadge.classList.remove("hidden");
        if (isAdmin) { adminPanel?.classList.remove("hidden"); btnDeleteAll?.classList.remove("hidden"); bindAdminStreams(); }
        else { adminPanel?.classList.add("hidden"); btnDeleteAll?.classList.add("hidden"); clearAdminStreams(); }
      } else {
        roleBadge.textContent = "no-role";
        roleBadge.classList.remove("hidden");
        adminPanel?.classList.add("hidden");
        btnDeleteAll?.classList.add("hidden");
      }
    }

    function setControlsEnabled() {
      setDisabled("btnNewWeek", !(currentUser && isAdmin));
      setDisabled("btnAddProject", !(currentUser && isAdmin));
      setDisabled("btnAddSample", !(currentUser && isAdmin));
      const checklist = document.getElementById("checklist");
      if (checklist) checklist.disabled = !(currentUser && isAdmin);
      renderProjects(latestProjects);
    }
    function setDisabled(id, yes) { const el = document.getElementById(id); if (el) el.disabled = !!yes; }

    /* ========= 4) 데이터 ========= */
    const tbody = document.getElementById("tbody");
    const top3El = document.getElementById("top3");
    const bottom3El = document.getElementById("bottom3");
    const kpiProgressEl = document.getElementById("kpiProgress");
    const kpiParcelsEl = document.getElementById("kpiParcels");
    const checklistEl = document.getElementById("checklist");
    const teamFilterEl = document.getElementById("teamFilter");

    let latestProjects = [];

    /* ========= 5) 렌더/계산 ========= */
    function pct1(completed, total) {
      const p = (!total || total <= 0) ? 0 : (completed / total * 100);
      return Math.round(p * 10) / 10;
    }
    function pctInt(completed, total) {
      const p = (!total || total <= 0) ? 0 : (completed / total * 100);
      return Math.round(p);
    }

    function updateGauge(doneAll, totalAll) {
      const progress = pct1(doneAll, totalAll);
      kpiProgressEl.textContent = progress.toFixed(1) + "%";
      kpiParcelsEl.textContent = `${doneAll} / ${totalAll} 필지`;

      const remain = Math.max(0, totalAll - doneAll);
      const data = { labels: ["완료", "잔여"], datasets: [{ data: [doneAll, remain] }] };
      const opt = { plugins: { legend: { labels: { color: "#cfe0ff" } } }, cutout: "60%", maintainAspectRatio: false, layout: { padding: 0 } };
      const ctx = document.getElementById("overallDonut");
      if (donutChart) { donutChart.data = data; donutChart.update(); }
      else { donutChart = new Chart(ctx, { type: "doughnut", data, options: opt }); }
    }

    function renderDashboardFromRows(rows) {
      const withPct = rows.map(r => {
        const p = (typeof r.progress === "number" && isFinite(r.progress))
          ? r.progress
          : pct1(Number(r.completed) || 0, Number(r.total) || 0);
        return { ...r, p };
      })
        .filter(r => (Number(r.total) || 0) > 0)
        .sort((a, b) => b.p - a.p);

      const top = withPct.slice(0, 3);
      const bottom = withPct.slice(-3).reverse();
      top3El.innerHTML = top.map(r => `<li>${esc(r.name)} <span class="muted">(${r.p.toFixed(1)}%)</span></li>`).join("");
      bottom3El.innerHTML = bottom.map(r => `<li>${esc(r.name)} <span class="muted">(${r.p.toFixed(1)}%)</span></li>`).join("");
    }

    async function recomputeAndPushStats(rows) {
      const totalAll = rows.reduce((s, r) => s + (Number(r.total) || 0), 0);
      const doneAll = rows.reduce((s, r) => s + (Number(r.completed) || 0), 0);
      try {
        await safeSet(statsRef, {
          total: totalAll,
          done: doneAll,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: auth.currentUser ? auth.currentUser.uid : null,
        });
      } catch (e) {
        console.debug('stats push skipped:', e.code || e.message);
      }
    }

    function renderProjects(rows) {
      if (!tbody) return;
      tbody.innerHTML = "";
      rows.forEach(r => {
        const total = Number(r.total) || 0;
        const comp = Number(r.completed) || 0;
        const last = Number(r.completed_last_week) || 0;
        const lastTotal = Number(r.total_last_week ?? r.total) || 0;

        const hasNowPct = (typeof r.progress === "number" && isFinite(r.progress));
        const hasPrevPct = (typeof r.progress_last_week === "number" && isFinite(r.progress_last_week));

        const pNowFromProgress = (typeof r.progress === "number" && isFinite(r.progress)) ? r.progress : null;
        const pNow1 = (pNowFromProgress !== null) ? pNowFromProgress : pct1(comp, total);
        const pPrev = pct1(last, total);
        const diff = Math.round((pNow1 - pPrev) * 10) / 10;
        const changed = Math.abs(diff) > 0.0001;
        const pInt = Math.round(pNow1);

        const tr = document.createElement("tr");
        tr.dataset.team = r.team || "";
        tr.innerHTML = `
          <td class="col-team">${esc(r.team || "")}</td>
          <td class="col-name">
            ${esc(r.name || "")}
            ${isAdmin ? ` <button class="btn danger btn-xs" data-del="${r.id}">삭제</button>` : ""}
          </td>
          <td class="col-total">
            <input type="number" class="in-total" data-id="${r.id}" value="${total}" ${isAdmin ? "" : "disabled"} />
          </td>
          <td class="col-done">
            <input type="number" class="in-completed" data-id="${r.id}" value="${comp}" ${(isAdmin || role === "lx") ? "" : "disabled"} />
          </td>
          <td class="col-progress">
            <div class="barwrap"><div class="bar" style="width:${Math.max(0, Math.min(100, pInt))}%"></div>
            <span class="barlabel">${pInt}%</span></div>
          </td>
          <td class="col-delta delta ${changed ? "changed" : ""}">${changed ? (diff > 0 ? "+" : "") + diff.toFixed(1) : "—"}</td>
          <td class="col-handover">
            <textarea class="in-lx" data-id="${r.id}" ${(isAdmin || role === "lx") ? "" : "disabled"}>${esc(r.lx_note || r.lxNotes || "")}</textarea>
          </td>
          <td class="col-feedback">
            <textarea class="in-auth" data-id="${r.id}" ${isAdmin ? "" : "disabled"}>${esc(r.authorityFeedback || "")}</textarea>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // 입력 바인딩
      tbody.querySelectorAll(".in-completed").forEach(el => {
        if (isAdmin) {
          el.addEventListener("input", debounce(e => {
            saveFieldRoot(e.target, "completed", toNum(e.target.value));
          }, 500));
        } else if (role === "lx") {
          el.addEventListener("input", debounce(e => {
            const tr = e.target.closest("tr");
            const total = toNum(tr.querySelector(".in-total")?.value);
            const completedCount = toNum(e.target.value);
            const percent = (!total || total <= 0) ? 0 : (completedCount / total * 100);
            const pInt = Math.max(0, Math.min(100, Math.round(percent))); // ← 오타 수정
            const projId = e.target.getAttribute("data-id");
            // 완료 개수 + 퍼센트 동시 저장
            saveCompletedAndProgress(projId, completedCount, pInt);
          }, 600));
        }
      });


      tbody.querySelectorAll(".in-lx").forEach(el => {
        if (!(isAdmin || role === "lx")) return;
        el.addEventListener("input", debounce(e => saveFieldRoot(e.target, "lx_note", e.target.value), 700));
      });

      tbody.querySelectorAll(".in-auth").forEach(el => {
        if (!isAdmin) return;
        el.addEventListener("input", debounce(e => saveFieldRoot(e.target, "authorityFeedback", e.target.value), 700));
      });

      if (isAdmin) {
        tbody.querySelectorAll("[data-del]").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.getAttribute("data-del");
            if (!id) return;
            if (!confirm("이 사업지구를 삭제할까요?")) return;
            try { await db.collection("projects").doc(id).delete(); }
            catch (err) { alert("삭제 실패: " + (err.message || err)); }
          });
        });
      }
    }

    function toNum(v) { const n = Number(v); return isFinite(n) ? n : 0; }
    function esc(s) { return String(s).replace(/[&<>\"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[c])); }

    // 안전 저장 유틸
    async function safeSet(ref, data, opt = { merge: true }) {
      console.log('[WRITE:set]', ref.path, data);
      try { await ref.set(data, opt); console.log('[OK:set]', ref.path); }
      catch (e) { console.error('[FAIL:set]', ref.path, data, e.code, e.message); throw e; }
    }
    async function safeUpdate(ref, data) {
      console.log('[WRITE:update]', ref.path, data);
      try { await ref.update(data); console.log('[OK:update]', ref.path); }
      catch (e) { console.error('[FAIL:update]', ref.path, data, e.code, e.message); throw e; }
    }

    // 루트 문서 필드 저장
    async function saveFieldRoot(el, field, value) {
      if (!(auth && currentUser && db)) return;
      const id = el.getAttribute("data-id");
      const ref = db.collection("projects").doc(id);
      const patch = (field === "lx_note") ? { lx_note: String(value) } : { [field]: value };
      try {
        await safeUpdate(ref, { ...patch, updatedAt: firebase.firestore.FieldValue.serverTimestamp(), updatedBy: currentUser.uid });
      } catch (e) {
        if (e.code === "not-found" || /NOT_FOUND/i.test(String(e.message))) {
          await safeSet(ref, { ...patch, updatedAt: firebase.firestore.FieldValue.serverTimestamp(), updatedBy: currentUser.uid }, { merge: true });
        } else if (e.code === "permission-denied") {
          alert("편집 권한이 없습니다. (관리자 승인/권한 필요)");
        } else {
          alert("저장 실패: " + (e.message || e));
        }
      }
    }

    // LX가 '완료 개수'와 '진행률(%)'을 함께 저장
    async function saveCompletedAndProgress(projectId, completedCount, percentInt) {
      if (!(auth && currentUser && db)) return;

      const done = Number(completedCount);
      const p = Number(percentInt);
      if (!Number.isFinite(done) || done < 0) { alert("완료(이번 주)는 0 이상 숫자여야 합니다."); return; }
      if (!Number.isFinite(p) || p < 0 || p > 100) { alert("진행률은 0~100 사이 숫자여야 합니다."); return; }

      const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
      const projRef = db.collection("projects").doc(projectId);

      // 1) 진행률 로그(서브컬렉션)
      await safeSet(projRef.collection("progress").doc(today), {
        progress: p,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: currentUser.uid
      }, { merge: true });

      // 2) 루트 문서에 완료 개수 + 퍼센트 동시 반영
      await safeUpdate(projRef, {
        completed: done,
        progress: p,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser.uid
      });

      console.log("[OK] completed & progress saved", projectId, done, p);
    }

    // 진행률(%)만 저장(퍼센트만 갱신할 때 사용)
    async function saveProgressPercent(projectId, percentInt) {
      if (!(auth && currentUser && db)) return;

      const p = Number(percentInt);
      if (!Number.isFinite(p) || p < 0 || p > 100) { alert("진행률은 0~100 사이 숫자여야 합니다."); return; }

      const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
      const projRef = db.collection("projects").doc(projectId);

      // 1) 진행률 로그(서브컬렉션)
      await safeSet(projRef.collection("progress").doc(today), {
        progress: p,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: currentUser.uid
      }, { merge: true });

      // 2) 루트 progress 갱신
      await safeUpdate(projRef, {
        progress: p,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser.uid
      });

      console.log("[OK] progress saved", projectId, p);
    }


    /* ========= 6) 버튼들 ========= */
    document.getElementById("btnNewWeek")?.addEventListener("click", async () => {
      if (!(auth && currentUser && db)) return alert("로그인 후 사용하세요.");
      if (!confirm('모든 사업지구의 "지난 주 완료" 값을 이번 주 완료 값으로 이월합니다. 진행할까요?')) return;
      try {
        const snap = await db.collection("projects").get();
        const batch = db.batch();
        snap.forEach(doc => {
          const d = doc.data();
          const totalNow = Number(d.total) || 0;
          const compNow = Number(d.completed) || 0;
          const progNow = (typeof d.progress === "number" && isFinite(d.progress))
            ? Number(d.progress)
            : Math.round((totalNow ? (compNow / totalNow * 100) : 0) * 10) / 10;

          batch.update(doc.ref, {
            completed_last_week: compNow,
            total_last_week: totalNow,             // ★ 지난주 분모 보존
            progress_last_week: progNow,           // ★ 지난주 % 값 보존(정확 비교용)
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        await batch.commit(); alert("새 주 시작 완료");
      } catch (e) { alert(e.message); }
    });


    document.getElementById("btnAddProject")?.addEventListener("click", async () => {
      if (!(auth && currentUser && db)) return alert("로그인 후 사용하세요.");
      const name = document.getElementById("inName").value.trim();
      const team = document.getElementById("inTeam").value.trim();
      const total = toNum(document.getElementById("inTotal").value);
      const completed = toNum(document.getElementById("inCompleted").value);
      if (!name || !team) return alert("사업지구명과 팀을 입력하세요.");
      try {
        await db.collection("projects").add({
          name, team, total, completed, completed_last_week: completed,
          lx_note: "", authorityFeedback: "",
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById("inName").value = "";
        document.getElementById("inTeam").value = "";
        document.getElementById("inTotal").value = "";
        document.getElementById("inCompleted").value = "";
      } catch (e) { alert("추가 실패: " + (e.message || e)); }
    });

    document.getElementById("btnAddSample")?.addEventListener("click", async () => {
      if (!(auth && currentUser && db)) return alert("로그인 후 사용하세요.");
      const samples = [
        { name: "제주-서부1지구", team: "A팀", total: 140, completed: 90 },
        { name: "제주-서부2지구", team: "A팀", total: 110, completed: 45 },
        { name: "제주-북부지구", team: "B팀", total: 95, completed: 80 },
        { name: "제주-중산간지구", team: "B팀", total: 200, completed: 60 },
        { name: "제주-서귀포지구", team: "C팀", total: 150, completed: 15 }
      ];
      try {
        const batch = db.batch();
        const col = db.collection("projects");
        samples.forEach(s => {
          const ref = col.doc();
          batch.set(ref, {
            ...s,
            completed_last_week: s.completed,
            lx_note: "",
            authorityFeedback: "",
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        await batch.commit(); alert("샘플 데이터 추가 완료");
      } catch (e) { alert("추가 실패: " + (e.message || e)); }
    });

    document.getElementById("btnExport")?.addEventListener("click", () => exportCSV(latestProjects));
    document.getElementById("btnRequestEdit")?.addEventListener("click", async () => {
      if (!(auth && currentUser && db)) return alert("로그인 후 사용하세요.");
      const note = prompt("요청 사유를 입력해 주세요 (lx 김형윤, 남원 ㅇㅇㅇ)");
      try {
        await db.collection("edit_requests").doc(currentUser.uid).set({
          uid: currentUser.uid, note: note || "", createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("요청이 등록되었습니다. 관리자 승인 후 편집 가능합니다.");
      } catch (e) { alert(e.message); }
    });

    btnDeleteAll?.addEventListener("click", async () => {
      if (!isAdmin) return alert("관리자만 가능합니다.");
      if (!confirm("모든 사업지구 문서를 삭제할까요? (되돌릴 수 없음)")) return;
      try {
        const snap = await db.collection("projects").get();
        const batch = db.batch();
        snap.forEach(d => batch.delete(d.ref));
        await batch.commit();
        alert("전체 삭제 완료");
      } catch (e) { alert("삭제 실패: " + (e.message || e)); }
    });

    /* ========= 7) CSV ========= */
    function exportCSV(rows) {
      const headers = ["team", "name", "total", "completed", "completed_last_week", "progress_now", "progress_prev", "delta_pp", "lx_note", "authorityFeedback"];
      const lines = [headers.join(",")];
      rows.forEach(r => {
        const total = Number(r.total) || 0, comp = Number(r.completed) || 0, last = Number(r.completed_last_week) || 0;
        const pNow = (typeof r.progress === "number" && isFinite(r.progress)) ? r.progress : pct1(comp, total);
        const pPrev = pct1(last, total);
        const d = (pNow - pPrev).toFixed(1);
        const vals = [r.team || "", r.name || "", total, comp, last, pNow.toFixed(1), pPrev.toFixed(1), d, quote(r.lx_note || r.lxNotes || ""), quote(r.authorityFeedback || "")];
        lines.push(vals.join(","));
      });
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([bom, lines.join("\r\n")], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "projects.csv";
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 0);
    }
    function quote(s) { const t = String(s).replaceAll('"', '""'); return `"${t}"`; }

    /* ========= 8) 관리자 패널 ========= */
    const requestsBox = document.getElementById("requests");
    const editorsBox = document.getElementById("editors");
    let unsubsAdmin = [];
    function clearAdminStreams() { unsubsAdmin.forEach(u => u && u()); unsubsAdmin = []; }
    function bindAdminStreams() {
      clearAdminStreams();
      if (!isAdmin) return;
      unsubsAdmin.push(
        db.collection("edit_requests").orderBy("createdAt", "desc").onSnapshot(snap => {
          if (!requestsBox) return;
          if (snap.empty) { requestsBox.innerHTML = '<div class="muted">대기 요청 없음</div>'; return; }
          requestsBox.innerHTML = snap.docs.map(d => {
            const x = d.data();
            return `<div class="flex" style="justify-content:space-between;border:1px solid #1b2446;border-radius:10px;padding:10px;margin:6px 0">
                  <div>
                    <div><b>UID:</b> ${d.id}</div>
                    <div class="muted">${esc(x.note || "요청 사유 없음")}</div>
                  </div>
                  <div class="btn-row">
                    <button class="btn accent" onclick="approveEditor('${d.id}')">승인(LX)</button>
                    <button class="btn danger" onclick="rejectRequest('${d.id}')">거절</button>
                  </div>
                </div>`;
          }).join("");
        })
      );
      unsubsAdmin.push(
        db.collection("roles").orderBy("role").onSnapshot(snap => {
          if (!editorsBox) return;
          if (snap.empty) { editorsBox.innerHTML = '<div class="muted">권한 사용자 없음</div>'; return; }
          editorsBox.innerHTML = snap.docs.map(d => {
            const x = d.data();
            return `<div class="flex" style="justify-content:space-between;border:1px solid #1b2446;border-radius:10px;padding:10px;margin:6px 0">
                  <div><b>${d.id.slice(0, 10)}...</b> <span class="badge">${esc(x.role)}</span></div>
                  <div class="btn-row">
                    ${x.role !== "admin" ? `<button class="btn danger" onclick="revokeEditor('${d.id}')">권한 회수</button>` : ""}
                  </div>
                </div>`;
          }).join("");
        })
      );
    }
    window.approveEditor = async function (targetUid) {
      try {
        await db.collection("roles").doc(targetUid).set({ role: "lx", grantedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
        await db.collection("edit_requests").doc(targetUid).delete();
        alert("승인 완료 (LX 권한)");
      } catch (e) { alert(e.message); }
    };
    window.rejectRequest = async function (targetUid) {
      try { await db.collection("edit_requests").doc(targetUid).delete(); }
      catch (e) { alert(e.message); }
    };
    window.revokeEditor = async function (targetUid) {
      if (!confirm("이 사용자의 권한을 회수할까요? (보기만 가능)")) return;
      try { await db.collection("roles").doc(targetUid).set({ role: "namwon" }, { merge: true }); alert("회수 완료"); }
      catch (e) { alert(e.message); }
    };

    /* ========= 9) 팀 필터 ========= */
    let lastTeamOptionSig = "";
    function buildTeamFilter(rows) {
      if (!teamFilterEl) return;
      const teams = Array.from(new Set(rows.map(r => (r.team || "").trim()).filter(Boolean))).sort();
      const sig = teams.join("|");
      if (sig === lastTeamOptionSig) return;
      const current = teamFilterEl.value || "__ALL__";
      teamFilterEl.innerHTML = `<option value="__ALL__">전체</option>` +
        teams.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join("");
      lastTeamOptionSig = sig;
      const keep = [...teamFilterEl.options].some(o => o.value === current);
      teamFilterEl.value = keep ? current : "__ALL__";
    }
    function applyTeamFilter() {
      if (!teamFilterEl) return;
      const v = teamFilterEl.value;
      document.querySelectorAll("#tbody tr").forEach(tr => {
        const t = (tr.dataset.team || "").trim();
        tr.style.display = (v === "__ALL__" || t === v) ? "" : "none";
      });
    }
    teamFilterEl?.addEventListener("change", applyTeamFilter);

    /* ========= 10) 유틸 ========= */
    function debounce(fn, wait) {
      let t; return function () {
        clearTimeout(t);
        const args = arguments; t = setTimeout(function () { fn.apply(null, args); }, wait);
      };
    }
  </script>

  <!-- 11) 캘린더 -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <script>
    /* ===== 캘린더(FullCalendar) + Firestore 연동 ===== */
    let calendar;
    let eventsUnsub = null;
    const CAL_COL = "calendar_events";

    function initCalendar() {
      const calendarEl = document.getElementById("calendar");
      if (!calendarEl) return;

      if (calendar) {
        calendar.setOption("editable", !!(currentUser && (isEditor || isAdmin)));
        calendar.setOption("selectable", !!(currentUser && (isEditor || isAdmin)));
        calendar.setOption("headerToolbar", { left: "prev,next today", center: "title", right: "dayGridMonth,timeGridWeek,timeGridDay" });
        return;
      }

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        height: 'parent',
        editable: !!(currentUser && (isEditor || isAdmin)),
        selectable: !!(currentUser && (isEditor || isAdmin)),
        headerToolbar: { left: "prev,next today", center: "title", right: "dayGridMonth,timeGridWeek,timeGridDay" },
        select: async function (info) {
          if (!(currentUser && (isEditor || isAdmin))) { calendar.unselect(); return; }
          const title = prompt("일정 제목을 입력하세요:");
          if (!title) { calendar.unselect(); return; }
          try {
            await db.collection(CAL_COL).add({
              title,
              start: info.start,
              end: info.end,
              allDay: info.allDay,
              createdBy: currentUser.uid,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } catch (e) { alert("일정 추가 실패: " + (e.message || e)); }
          finally { calendar.unselect(); }
        },
        eventClick: async function (info) {
          if (!(currentUser && (isEditor || isAdmin))) return;
          if (!confirm("이 일정을 삭제할까요?")) return;
          try { await db.collection(CAL_COL).doc(info.event.id).delete(); }
          catch (e) { alert("삭제 실패: " + (e.message || e)); }
        },
        eventDrop: async function (info) {
          if (!(currentUser && (isEditor || isAdmin))) { info.revert(); return; }
          try {
            await db.collection(CAL_COL).doc(info.event.id).update({
              start: info.event.start,
              end: info.event.end,
              allDay: info.event.allDay,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } catch (e) { info.revert(); alert("이동 실패: " + (e.message || e)); }
        },
        eventResize: async function (info) {
          if (!(currentUser && (isEditor || isAdmin))) { info.revert(); return; }
          try {
            await db.collection(CAL_COL).doc(info.event.id).update({
              start: info.event.start,
              end: info.event.end,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } catch (e) { info.revert(); alert("수정 실패: " + (e.message || e)); }
        }
      });

      calendar.render();
    }

    function bindCalendarStreams() {
      if (eventsUnsub) { eventsUnsub(); eventsUnsub = null; }
      if (!db) return;

      eventsUnsub = db.collection(CAL_COL)
        .orderBy("start", "asc")
        .onSnapshot((snap) => {
          if (!calendar) return;
          snap.docChanges().forEach((chg) => {
            const id = chg.doc.id;
            const d = chg.doc.data();
            const ev = {
              id,
              title: d.title || "(제목 없음)",
              start: d.start ? new Date(d.start.seconds ? d.start.seconds * 1000 : d.start) : null,
              end: d.end ? new Date(d.end.seconds ? d.end.seconds * 1000 : d.end) : null,
              allDay: !!d.allDay
            };
            if (chg.type === "added") {
              const exist = calendar.getEventById(id); if (exist) exist.remove();
              calendar.addEvent(ev);
            } else if (chg.type === "modified") {
              const e = calendar.getEventById(id);
              if (e) { e.setProp("title", ev.title); e.setDates(ev.start, ev.end, { allDay: ev.allDay }); }
              else { calendar.addEvent(ev); }
            } else if (chg.type === "removed") {
              const e = calendar.getEventById(id); e && e.remove();
            }
          });
        }, (err) => { console.warn("calendar_events listen error:", err); });
    }
  </script>
</body>

</html>