<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>사업지구 공정률 대시보드</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <style>
    :root { --bg:#0b1020; --card:#111834; --muted:#8fa3c1; --text:#e8eefb; --brand:#5aa0ff; --accent:#46e0b7; --danger:#ef4444; --ring:#233053; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0a0f1e 0%,#0b1226 100%);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(10,15,30,.7);border-bottom:1px solid #1b2446}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .row{display:grid;gap:16px}
    .row.cols-2{grid-template-columns:repeat(2,1fr)}
    .card{background:linear-gradient(180deg,#0f1732 0%,#0e1530 100%);border:1px solid #1b2446;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .card h2{font-size:18px;margin:0 0 8px 0;color:#cfe0ff}
    .card .pad{padding:16px}
    .kpi{display:flex;align-items:baseline;gap:8px}
    .kpi .big{font-size:24px;font-weight:800}
    .kpi .sub{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:1px solid #2a3a70;background:#12204a;color:#eaf2ff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn:hover{background:#16265a}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .danger{background:#2b0e13;border-color:#4a0d17}
    .danger:hover{background:#3a131a}
    .accent{background:#0d2b24;border-color:#0a4034}
    .accent:hover{background:#123c32}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    thead th{font-size:12px;text-transform:uppercase;color:#a9b8d9;text-align:left;padding:0 8px}
    tbody td{background:linear-gradient(180deg,#0f1732 0%,#0e1530 100%);border:1px solid #1b2446;border-left:0;border-right:0;padding:12px 8px}
    tbody tr{border-radius:12px;overflow:hidden}
    tbody td:first-child{border-left:1px solid #1b2446;border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody td:last-child{border-right:1px solid #1b2446;border-top-right-radius:12px;border-bottom-right-radius:12px}

    input[type="number"], input[type="text"], textarea, select{
      width:100%;background:#0a1330;border:1px solid #1f2c57;color:#e8eefb;border-radius:10px;padding:8px;outline:none
    }
    input:focus, textarea:focus{box-shadow:0 0 0 3px var(--ring)}
    textarea{min-height:64px;resize:vertical}

    .delta{font-weight:700}
    .delta.changed{color:var(--danger)}
    .tag{display:inline-flex;align-items:center;gap:6px;border:1px solid #27407d;background:#0c1a3f;padding:6px 10px;border-radius:999px;font-size:12px;color:#cfe0ff}
    .footer{color:#91a1c4;font-size:12px;margin-top:8px}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .hidden{display:none}

    .dash{display:grid;grid-template-columns:380px 1fr;gap:16px}
    @media (max-width: 980px){ .dash{grid-template-columns:1fr} }
    .dash-right{display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:minmax(0,auto);gap:16px}
    .span-2{grid-column:1 / span 2}
    .badge{border:1px solid #2d3d72;background:#0e1b40;padding:4px 8px;border-radius:999px;font-size:12px;color:#cfe0ff}
  </style>
</head>
<body>
  <header>
    <div class="wrap flex" style="padding:12px 20px">
      <div class="flex" style="gap:10px">
        <span class="tag">사업지구 공정률 대시보드</span>
        <span class="muted">실시간 동기화 (Firebase · 아이디 로그인)</span>
      </div>
      <div class="spacer"></div>
      <div class="flex">
        <span id="userInfo" class="muted">로그인 필요</span>
        <span id="roleBadge" class="badge hidden"></span>
        <button id="btnSignIn" class="btn">로그인</button>
        <button id="btnSignOut" class="btn hidden">로그아웃</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:16px">
    <div class="dash">
      <div class="card"><div class="pad">
        <h2>전체 공정률</h2>
        <div class="kpi"><span id="kpiProgress" class="big">0%</span><span class="sub" id="kpiParcels">0 / 0 필지</span></div>
        <canvas id="overallDonut" style="margin-top:6px;height:120px"></canvas>
      </div></div>

      <div class="dash-right">
        <div class="card"><div class="pad">
          <h2>Top 3 사업지구</h2>
          <ol id="top3" class="muted" style="padding-left:18px;margin:0"></ol>
          <div class="footer">진행률(%) 기준</div>
        </div></div>
        <div class="card"><div class="pad">
          <h2>Bottom 3 사업지구</h2>
          <ol id="bottom3" class="muted" style="padding-left:18px;margin:0"></ol>
          <div class="footer">진행률(%) 기준</div>
        </div></div>
        <div class="card span-2"><div class="pad">
          <h2>확인사항</h2>
          <textarea id="checklist" placeholder="예: 자료 보완 대상 지구, 일정 리스크, 대민 안내 필요사항 등" disabled></textarea>
          <div class="footer">※ 관리자만 편집 · 실시간 공유</div>
        </div></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px"><div class="pad">
      <h2>관리 도구</h2>
      <div class="btn-row" style="margin-bottom:10px">
        <button id="btnNewWeek" class="btn" disabled>새 주 시작(지난 주 이월)</button>
        <button id="btnAddSample" class="btn accent" disabled>샘플 데이터 추가</button>
        <button id="btnExport" class="btn">CSV 내보내기</button>
        <button id="btnRequestEdit" class="btn">편집 권한 요청</button>
      </div>
      <div class="row cols-2">
        <div>
          <h3 style="margin:0 0 8px 0;color:#cfe0ff;font-size:14px">사업지구 추가</h3>
          <div class="row cols-2">
            <input id="inName" type="text" placeholder="사업지구명" />
            <input id="inTeam" type="text" placeholder="담당팀" />
          </div>
          <div class="row cols-2" style="margin-top:8px">
            <input id="inTotal" type="number" placeholder="총 필지" />
            <input id="inCompleted" type="number" placeholder="완료(이번 주)" />
          </div>
          <div class="btn-row" style="margin-top:8px">
            <button id="btnAddProject" class="btn" disabled>추가</button>
          </div>
          <div class="footer">※ ADMIN만 추가/삭제 가능. Δ는 지난 주 대비 변화(pp).</div>
        </div>
        <div>
          <h3 style="margin:0 0 8px 0;color:#cfe0ff;font-size:14px">설명</h3>
          <ul class="muted" style="margin:0 0 6px 16px;padding:0">
            <li>좌: 전체 공정률 도넛(높이 절반)</li>
            <li>우: Top/Bottom3 + 확인사항(실시간)</li>
            <li>표: 팀별 현황, Δ(pp), LX/소관청 메모</li>
          </ul>
        </div>
      </div>
    </div></div>

    <div class="card" style="margin-top:16px"><div class="pad">
      <h2>담당팀별 사업지구 현황</h2>
      <table>
        <thead>
          <tr>
            <th>담당팀</th>
            <th>사업지구</th>
            <th>총 필지</th>
            <th>완료 (이번 주)</th>
            <th>공정률 (%)</th>
            <th>Δ 주간 (pp)</th>
            <th>LX 인수인계</th>
            <th>소관청 피드백</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div></div>

    <div id="adminPanel" class="card hidden" style="margin-top:16px"><div class="pad">
      <h2>관리자 패널 · 권한 승인</h2>
      <div class="footer">여기 보이는 항목은 <b>role=admin</b> 사용자에게만 표시됩니다.</div>
      <h3 style="color:#cfe0ff;margin-top:12px">승인 대기 요청</h3>
      <div id="requests"></div>
      <h3 style="color:#cfe0ff;margin-top:12px">현재 권한 사용자</h3>
      <div id="editors"></div>
    </div></div>

  </main>

<script>
/* ========= 1) Firebase 설정 ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBDQSpN1_hV5cj9wDHqzxwIEfWHUsuMEu0",
  authDomain: "weekend-6d16d.firebaseapp.com",
  projectId: "weekend-6d16d",
  storageBucket: "weekend-6d16d.appspot.com",
  messagingSenderId: "399772383646",
  appId: "1:399772383646:web:21208b83404479669c3e8f",
  measurementId: "G-35FK2FRMBZ"
};
const USER_DOMAIN = "acct.lx.local"; // A안: 아이디 → 가짜 이메일 도메인

/* ========= 2) 초기화 ========= */
let app, db, auth;
let donutChart = null;
let currentUser = null;
let role = null;         // "admin" | "lx" | "namwon" | null
let isEditor = false;    // (role === "admin" || role === "lx")
let isAdmin  = false;

try {
  app  = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
  db   = firebase.firestore();
  auth = firebase.auth();
} catch (err) {
  console.error("[Firebase 초기화 실패]", err);
  document.getElementById("userInfo").textContent = "Firebase 미설정";
}

/* ========= 3) 인증 (아이디/비밀번호) + 스트림 바인딩 ========= */
const btnSignIn  = document.getElementById("btnSignIn");
const btnSignOut = document.getElementById("btnSignOut");
const userInfo   = document.getElementById("userInfo");
const roleBadge  = document.getElementById("roleBadge");
const adminPanel = document.getElementById("adminPanel");

let unsubs = []; // 데이터 스트림 해제용
function clearDataStreams(){ unsubs.forEach(u=>u&&u()); unsubs=[]; }

function bindDataStreams(){
  clearDataStreams();
  if (!db || !currentUser) return;

  // projects
  unsubs.push(
    db.collection("projects").orderBy("team").onSnapshot((snap) => {
      latestProjects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      latestProjects.sort((a,b)=>
        String(a.team||"").localeCompare(String(b.team||"")) ||
        String(a.name||"").localeCompare(String(b.name||""))
      );
      renderProjects(latestProjects);
      renderDashboard(latestProjects);
    }, (err) => {
      console.warn("projects listen error:", err.code || err.message);
    })
  );

  // settings
  unsubs.push(
    db.collection("settings").doc("dashboard").onSnapshot(doc => {
      const d = doc.data() || {};
      if (checklistEl) checklistEl.value = d.checklist || "";
    }, (err)=>{
      console.warn("settings listen error:", err.code || err.message);
    })
  );
}

if (auth) {
  auth.onAuthStateChanged(async (user) => {
    currentUser = user;
    if (user) {
      const idLike = user.email ? user.email.split("@")[0] : user.uid.slice(0,6);
      userInfo.textContent = `${idLike} 접속`;
      btnSignIn.classList.add("hidden");
      btnSignOut.classList.remove("hidden");

      await refreshRole();   // role, isEditor, isAdmin 갱신
      setControlsEnabled();  // 버튼/입력 가능 여부 갱신
      bindDataStreams();     // ★ 로그인/역할 확인 후 스트림 연결
    } else {
      userInfo.textContent = "로그인 필요";
      btnSignIn.classList.remove("hidden");
      btnSignOut.classList.add("hidden");
      roleBadge.classList.add("hidden");
      role = null; isEditor = false; isAdmin = false;
      setControlsEnabled();
      clearDataStreams();    // ★ 로그아웃 시 스트림 해제
      latestProjects = []; renderProjects(latestProjects); renderDashboard(latestProjects);
    }
  });

  btnSignIn.addEventListener("click", async () => {
    try {
      const username = prompt("아이디를 입력하세요 (예: ADMIN, LX01, NAMWON)");
      if (!username) return;
      const password = prompt("비밀번호를 입력하세요");
      if (!password) return;
      const email = `${username.trim()}@${USER_DOMAIN}`;
      await auth.signInWithEmailAndPassword(email, password);
    } catch (e) {
      alert(`[로그인 실패] ${e.code || ""} ${e.message || e}`);
    }
  });
  btnSignOut.addEventListener("click", async () => { await auth.signOut(); });
}

async function refreshRole() {
  role = null; isEditor = false; isAdmin = false;
  if (!(db && currentUser)) return;
  const r = await db.collection("roles").doc(currentUser.uid).get();
  if (r.exists) {
    role = String(r.data().role || "").toLowerCase();
    isAdmin  = role === "admin";
    isEditor = role === "admin" || role === "lx";
    roleBadge.textContent = role || "unknown";
    roleBadge.classList.remove("hidden");
    if (isAdmin) { adminPanel && adminPanel.classList.remove("hidden"); bindAdminStreams(); }
    else         { adminPanel && adminPanel.classList.add("hidden");    clearAdminStreams(); }
  } else {
    roleBadge.textContent = "no-role";
    roleBadge.classList.remove("hidden");
    adminPanel && adminPanel.classList.add("hidden");
  }
}

function setControlsEnabled() {
  setDisabled("btnNewWeek",   !(currentUser && isAdmin));
  setDisabled("btnAddProject",!(currentUser && isAdmin));
  setDisabled("btnAddSample", !(currentUser && isAdmin));
  const checklist = document.getElementById("checklist");
  if (checklist) checklist.disabled = !(currentUser && isAdmin);
  renderProjects(latestProjects);
}
function setDisabled(id, yes){ const el = document.getElementById(id); if (el) el.disabled = !!yes; }

/* ========= 4) 데이터 (스트림은 bindDataStreams에서 붙임) ========= */
const tbody         = document.getElementById("tbody");
const top3El        = document.getElementById("top3");
const bottom3El     = document.getElementById("bottom3");
const kpiProgressEl = document.getElementById("kpiProgress");
const kpiParcelsEl  = document.getElementById("kpiParcels");
const checklistEl   = document.getElementById("checklist");

let latestProjects = [];

// 관리자만 수정 가능(규칙 불일치 시 권한거부 에러)
checklistEl && checklistEl.addEventListener("input", debounce(async ()=>{
  if (!(auth && currentUser && db)) return;
  try {
    await db.collection("settings").doc("dashboard").set({
      checklist: checklistEl.value,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
  } catch (e) {
    if (e.code === "permission-denied") alert("관리자 권한이 필요합니다.");
    else console.error(e);
  }
}, 600));

/* ========= 5) 렌더/계산 ========= */
function pct(completed, total){
  const p = (!total || total<=0) ? 0 : (completed/total*100);
  return Math.round(p*10)/10;
}

function renderDashboard(rows){
  const totalAll = rows.reduce((s,r)=>s+(Number(r.total)||0),0);
  const doneAll  = rows.reduce((s,r)=>s+(Number(r.completed)||0),0);
  const progress = pct(doneAll,totalAll);
  kpiProgressEl.textContent = progress.toFixed(1) + "%";
  kpiParcelsEl.textContent  = `${doneAll} / ${totalAll} 필지`;

  const remain = Math.max(0,totalAll-doneAll);
  const data = { labels:["완료","잔여"], datasets:[{ data:[doneAll, remain] }] };
  const opt  = { plugins:{ legend:{ labels:{ color:"#cfe0ff" } } }, cutout:"60%" };
  const ctx  = document.getElementById("overallDonut");
  if (donutChart) { donutChart.data = data; donutChart.update(); }
  else { donutChart = new Chart(ctx, { type:"doughnut", data, options: opt }); }

  const withPct = rows.map(r=>({...r, p: pct(Number(r.completed)||0, Number(r.total)||0)}))
                      .filter(r=> (Number(r.total)||0) > 0)
                      .sort((a,b)=>b.p - a.p);
  const top = withPct.slice(0,3);
  const bottom = withPct.slice(-3).reverse();
  top3El.innerHTML    = top.map(r=>`<li>${esc(r.name)} <span class="muted">(${r.p.toFixed(1)}%)</span></li>`).join("");
  bottom3El.innerHTML = bottom.map(r=>`<li>${esc(r.name)} <span class="muted">(${r.p.toFixed(1)}%)</span></li>`).join("");
}

function renderProjects(rows){
  if (!tbody) return;
  tbody.innerHTML = "";
  rows.forEach(r=>{
    const total = Number(r.total)||0;
    const comp  = Number(r.completed)||0;
    const last  = Number(r.completed_last_week)||0;
    const pNow  = pct(comp,total);
    const pPrev = pct(last,total);
    const diff  = Math.round((pNow - pPrev)*10)/10;
    const changed = Math.abs(diff) > 0.0001;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(r.team||"")}</td>
      <td>${esc(r.name||"")}</td>
      <td><input type="number" class="in-total"     data-id="${r.id}" value="${total}" ${inputEditable()} /></td>
      <td><input type="number" class="in-completed" data-id="${r.id}" value="${comp}"  ${inputEditable()} /></td>
      <td>${pNow.toFixed(1)}%</td>
      <td class="delta ${changed?"changed":""}">${changed ? (diff>0?"+":"")+diff.toFixed(1) : "—"}</td>
      <td><textarea class="in-lx"   data-id="${r.id}" ${inputEditable()}>${esc(r.lxNotes||"")}</textarea></td>
      <td><textarea class="in-auth" data-id="${r.id}" ${inputEditable()}>${esc(r.authorityFeedback||"")}</textarea></td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll(".in-total").forEach(el=>{
    el.addEventListener("input", debounce(e=> saveField(e.target,"total", toNum(e.target.value)), 500));
  });
  tbody.querySelectorAll(".in-completed").forEach(el=>{
    el.addEventListener("input", debounce(e=> saveField(e.target,"completed", toNum(e.target.value)), 500));
  });
  tbody.querySelectorAll(".in-lx").forEach(el=>{
    el.addEventListener("input", debounce(e=> saveField(e.target,"lxNotes", e.target.value), 700));
  });
  tbody.querySelectorAll(".in-auth").forEach(el=>{
    el.addEventListener("input", debounce(e=> saveField(e.target,"authorityFeedback", e.target.value), 700));
  });
}

function inputEditable(){ return (auth && currentUser && (isEditor || isAdmin)) ? "" : "disabled"; }
function toNum(v){ const n = Number(v); return isFinite(n)? n: 0; }
function esc(s){
  return String(s).replace(/[&<>\"']/g, function(c){
    return {
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;",
      "'": "&#39;"
    }[c];
  });
}

async function saveField(el, field, value){
  if (!(auth && currentUser && db)) return;
  try{
    const id = el.getAttribute("data-id");
    await db.collection("projects").doc(id).update({
      [field]: value,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }catch(e){
    if (e.code === "permission-denied") alert("편집 권한이 없습니다. (관리자 승인/권한 필요)");
    else alert("저장 실패: " + e.message);
  }
}

/* ========= 6) 버튼들 ========= */
document.getElementById("btnNewWeek") && document.getElementById("btnNewWeek").addEventListener("click", async () => {
  if(!(auth && currentUser && db)) return alert("로그인 후 사용하세요.");
  if(!confirm('모든 사업지구의 "지난 주 완료" 값을 이번 주 완료 값으로 이월합니다. 진행할까요?')) return;
  try{
    const snap = await db.collection("projects").get();
    const batch = db.batch();
    snap.forEach(doc => {
      const d = doc.data();
      batch.update(doc.ref, { completed_last_week: Number(d.completed)||0, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    });
    await batch.commit(); alert("새 주 시작 완료");
  } catch(e){ alert(e.message); }
});

document.getElementById("btnAddProject") && document.getElementById("btnAddProject").addEventListener("click", async () => {
  if(!(auth && currentUser && db)) return alert("로그인 후 사용하세요.");
  const name = document.getElementById("inName").value.trim();
  const team = document.getElementById("inTeam").value.trim();
  const total = toNum(document.getElementById("inTotal").value);
  const completed = toNum(document.getElementById("inCompleted").value);
  if(!name || !team) return alert("사업지구명과 팀을 입력하세요.");
  try{
    await db.collection("projects").add({
      name, team, total, completed, completed_last_week: completed,
      lxNotes:"", authorityFeedback:"",
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById("inName").value="";
    document.getElementById("inTeam").value="";
    document.getElementById("inTotal").value="";
    document.getElementById("inCompleted").value="";
  } catch(e){ alert("추가 실패: " + e.message); }
});

document.getElementById("btnAddSample") && document.getElementById("btnAddSample").addEventListener("click", async () => {
  if(!(auth && currentUser && db)) return alert("로그인 후 사용하세요.");
  const samples = [
    {name:"제주-서부1지구", team:"A팀", total:140, completed:90},
    {name:"제주-서부2지구", team:"A팀", total:110, completed:45},
    {name:"제주-북부지구",  team:"B팀", total:95,  completed:80},
    {name:"제주-중산간지구",team:"B팀", total:200, completed:60},
    {name:"제주-서귀포지구",team:"C팀", total:150, completed:15}
  ];
  try{
    const batch = db.batch();
    const col = db.collection("projects");
    samples.forEach(s => {
      const ref = col.doc();
      batch.set(ref, { ...s, completed_last_week: s.completed, lxNotes:"", authorityFeedback:"", updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    });
    await batch.commit(); alert("샘플 데이터 추가 완료");
  } catch(e){ alert(e.message); }
});

document.getElementById("btnExport") && document.getElementById("btnExport").addEventListener("click", () => exportCSV(latestProjects));
document.getElementById("btnRequestEdit") && document.getElementById("btnRequestEdit").addEventListener("click", async () => {
  if(!(auth && currentUser && db)) return alert("로그인 후 사용하세요.");
  const note = prompt("요청 사유를 입력해 주세요 (팀/업무 등)");
  try{
    await db.collection("edit_requests").doc(currentUser.uid).set({
      uid: currentUser.uid, note: note||"", createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("요청이 등록되었습니다. 관리자 승인 후 편집 가능합니다.");
  } catch(e){ alert(e.message); }
});

/* ========= 7) CSV ========= */
function exportCSV(rows){
  const headers = ["team","name","total","completed","completed_last_week","progress_now","progress_prev","delta_pp","lxNotes","authorityFeedback"];
  const lines = [headers.join(",")];
  rows.forEach(r => {
    const total = Number(r.total)||0, comp=Number(r.completed)||0, last=Number(r.completed_last_week)||0;
    const pNow=pct(comp,total), pPrev=pct(last,total), d=(pNow-pPrev).toFixed(1);
    const vals = [r.team||"", r.name||"", total, comp, last, pNow.toFixed(1), pPrev.toFixed(1), d, quote(r.lxNotes||""), quote(r.authorityFeedback||"")];
    lines.push(vals.join(","));
  });
  const bom = new Uint8Array([0xEF,0xBB,0xBF]);
  const blob = new Blob([bom, lines.join("\r\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "projects.csv";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),0);
}
function quote(s){ const t = String(s).replaceAll('"','""'); return `"${t}"`; }

/* ========= 8) 관리자 패널 ========= */
const requestsBox = document.getElementById("requests");
const editorsBox  = document.getElementById("editors");
let unsubsAdmin = [];
function clearAdminStreams(){ unsubsAdmin.forEach(u=>u&&u()); unsubsAdmin=[]; }
function bindAdminStreams(){
  clearAdminStreams();
  if(!isAdmin) return;
  unsubsAdmin.push(
    db.collection("edit_requests").orderBy("createdAt","desc").onSnapshot(snap=>{
      if(!requestsBox) return;
      if(snap.empty){ requestsBox.innerHTML = '<div class="muted">대기 요청 없음</div>'; return; }
      requestsBox.innerHTML = snap.docs.map(d=>{
        const x=d.data();
        return `<div class="flex" style="justify-content:space-between;border:1px solid #1b2446;border-radius:10px;padding:10px;margin:6px 0">
                  <div>
                    <div><b>UID:</b> ${d.id}</div>
                    <div class="muted">${esc(x.note||"요청 사유 없음")}</div>
                  </div>
                  <div class="btn-row">
                    <button class="btn accent" onclick="approveEditor('${d.id}')">승인(LX)</button>
                    <button class="btn danger" onclick="rejectRequest('${d.id}')">거절</button>
                  </div>
                </div>`;
      }).join("");
    })
  );
  unsubsAdmin.push(
    db.collection("roles").orderBy("role").onSnapshot(snap=>{
      if(!editorsBox) return;
      if(snap.empty){ editorsBox.innerHTML = '<div class="muted">권한 사용자 없음</div>'; return; }
      editorsBox.innerHTML = snap.docs.map(d=>{
        const x=d.data();
        return `<div class="flex" style="justify-content:space-between;border:1px solid #1b2446;border-radius:10px;padding:10px;margin:6px 0">
                  <div><b>${d.id.slice(0,10)}...</b> <span class="badge">${esc(x.role)}</span></div>
                  <div class="btn-row">
                    ${x.role!=="admin" ? `<button class="btn danger" onclick="revokeEditor('${d.id}')">권한 회수</button>` : ""}
                  </div>
                </div>`;
      }).join("");
    })
  );
}
window.approveEditor = async function(targetUid){
  try{
    await db.collection("roles").doc(targetUid).set({ role:"lx", grantedAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
    await db.collection("edit_requests").doc(targetUid).delete();
    alert("승인 완료 (LX 권한)");
  }catch(e){ alert(e.message); }
};
window.rejectRequest = async function(targetUid){
  try{ await db.collection("edit_requests").doc(targetUid).delete(); }
  catch(e){ alert(e.message); }
};
window.revokeEditor = async function(targetUid){
  if(!confirm("이 사용자의 권한을 회수할까요? (보기만 가능)")) return;
  try{ await db.collection("roles").doc(targetUid).set({ role:"namwon" }, {merge:true}); alert("회수 완료"); }
  catch(e){ alert(e.message); }
};

/* ========= 9) 유틸 ========= */
function debounce(fn, wait){ let t; return function(){ clearTimeout(t); const args=arguments; t=setTimeout(function(){ fn.apply(null,args); }, wait); }; }
</script>

</body>
</html>
